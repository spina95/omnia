import{G as l,K as g,Wb as f}from"./chunk-N2NO2H5W.js";import{a as c,b as u}from"./chunk-VOSPIT4N.js";var m=class o{constructor(t){this.supabaseService=t}bucket="documents";async getCurrentUserId(){let{data:t}=await this.supabaseService.client.auth.getUser();return t?.user?.id??null}async listCategories(){let t=await this.getCurrentUserId(),r=this.supabaseService.client.from("document_categories").select("*").order("created_at",{ascending:!1});t&&(r=r.eq("user_id",t));let{data:e,error:a}=await r;if(a)throw a;return e??[]}async createCategory(t){let r=await this.getCurrentUserId(),e=u(c({},t),{user_id:r}),{data:a,error:s}=await this.supabaseService.client.from("document_categories").insert([e]).select().single();if(s)throw s;return a}async deleteCategory(t){let r=await this.getCurrentUserId(),e=this.supabaseService.client.from("document_categories").delete().eq("id",t);r&&(e=e.eq("user_id",r));let{error:a}=await e;if(a)throw a}async createDocumentMetadata(t){let r=await this.getCurrentUserId(),e=u(c({},t),{user_id:r});e.category_id!==null&&e.category_id!==void 0?e.category_id=Number(e.category_id):e.category_id=null,console.debug("DocumentsService.createDocumentMetadata: toInsert =",e);let{data:a,error:s}=await this.supabaseService.client.from("documents").insert([e]).select().single();if(s)throw s;return a}async listDocuments(t={}){let r=await this.getCurrentUserId(),e=t.page??1,a=t.pageSize??12,s=t.search??"",n=(e-1)*a,y=n+a-1,i=this.supabaseService.client.from("documents").select("*, document_categories(id, name)",{count:"exact"}).order("created_at",{ascending:!1});t.categoryId&&(i=i.eq("category_id",Number(t.categoryId))),r&&(i=i.eq("user_id",r)),s&&(i=i.ilike("name",`%${s}%`));let{data:h,error:d,count:p}=await i.range(n,y);if(d)throw d;return{data:h??[],count:p??0}}async uploadFile(t,r){let{data:e,error:a}=await this.supabaseService.client.storage.from(this.bucket).upload(r,t,{cacheControl:"3600",upsert:!1});if(a)throw a;return e}async generateSignedDownloadUrl(t,r=300){let{data:e,error:a}=await this.supabaseService.client.storage.from(this.bucket).createSignedUrl(t,r);if(a)throw a;return e}async deleteFileFromStorage(t){let{data:r,error:e}=await this.supabaseService.client.storage.from(this.bucket).remove([t]);if(e)throw e;return r}async deleteDocument(t){let r=await this.getCurrentUserId(),e=this.supabaseService.client.from("documents").delete().eq("id",t);r&&(e=e.eq("user_id",r));let{data:a,error:s}=await e;if(s)throw s;return a}async updateDocument(t,r){let e=await this.getCurrentUserId(),a=this.supabaseService.client.from("documents").update(r).eq("id",t);e&&(a=a.eq("user_id",e));let{data:s,error:n}=await a.select().single();if(n)throw n;return s}static \u0275fac=function(r){return new(r||o)(g(f))};static \u0275prov=l({token:o,factory:o.\u0275fac,providedIn:"root"})};export{m as a};
