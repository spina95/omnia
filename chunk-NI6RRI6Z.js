import{a as ge}from"./chunk-SNTUHFST.js";import{a as Te,b as Ie}from"./chunk-6Z6DACZO.js";import{a as Ee}from"./chunk-RFEMKXXG.js";import"./chunk-6QJJMWVY.js";import{a as Ve}from"./chunk-OBDD5TNP.js";import{a as W,b as De}from"./chunk-JP5UYGYO.js";import{a as Se}from"./chunk-NIHZNVXE.js";import{a as ke}from"./chunk-J2WFLVCT.js";import{b as he,d as ve,e as _e,f as xe,g as ye,h as be,i as Ce,o as we,r as j}from"./chunk-FEREQUKV.js";import{$a as y,Fb as ne,Ga as q,H as re,Hb as R,Ka as C,L as ee,M as T,Mb as ue,Pa as oe,Qa as p,Ra as r,S as f,Sa as o,T as h,Ta as x,U as S,V as I,Yb as pe,Zb as B,_ as te,_a as E,bb as d,da as _,ec as $,fb as se,ga as ae,gb as le,hb as ce,jc as Q,kb as de,kc as fe,l as H,mb as U,ob as F,pb as c,qb as O,rb as k,ua as l,ub as M,vb as N,wb as A,yb as me}from"./chunk-MW6OH7V5.js";import{a as J,b as Z}from"./chunk-VOSPIT4N.js";var Le={NYSE:"USA",NASDAQ:"USA",NasdaqGS:"USA",NasdaqGM:"USA",NasdaqCM:"USA",NYQ:"USA",PCX:"USA",XETRA:"Germany",FRA:"Germany",LSE:"United Kingdom",LON:"United Kingdom",TSE:"Japan",JPX:"Japan","Euronext Paris":"France",PAR:"France",SIX:"Switzerland",VTX:"Switzerland",BME:"Spain",BIT:"Italy",MIL:"Italy",AMS:"Netherlands",TSX:"Canada",TOR:"Canada",ASX:"Australia",HKSE:"Hong Kong",HKG:"Hong Kong",SSE:"China",SHH:"China",SZSE:"China",SHZ:"China",BSE:"India",NSE:"India",BOM:"India"},L=class s{constructor(t,e){this.supabase=t;this.http=e}async getTransactions(t){let e=t?.page||1,i=t?.pageSize||100,n=(e-1)*i,a=n+i-1,{data:g}=await this.supabase.client.auth.getSession();console.log("\u{1F510} Current session:",g?.session?"Authenticated":"Not authenticated"),console.log("\u{1F464} User ID:",g?.session?.user?.id);let v=this.supabase.client.from("investment_transactions").select("*",{count:"exact"}).order("transaction_date",{ascending:!1});t?.ticker&&(v=v.ilike("ticker",t.ticker)),t?.transactionType&&(v=v.eq("transaction_type",t.transactionType)),t?.startDate&&(v=v.gte("transaction_date",t.startDate)),t?.endDate&&(v=v.lte("transaction_date",t.endDate)),v=v.range(n,a);let{data:D,error:b,count:w}=await v;if(console.log("\u{1F4CA} Investment transactions query result:",{dataCount:D?.length,totalCount:w,error:b}),b)throw console.error("\u274C Error fetching transactions:",b),new Error(b.message);return{data:D||[],count:w||0}}async getTransactionById(t){let{data:e,error:i}=await this.supabase.client.from("investment_transactions").select("*").eq("id",t).single();if(i)throw console.error("Error fetching transaction:",i),new Error(i.message);return e}async createTransaction(t){let{data:e,error:i}=await this.supabase.client.from("investment_transactions").insert(t).select().single();if(i)throw console.error("Error creating transaction:",i),new Error(i.message);return e}async updateTransaction(t,e){let{data:i,error:n}=await this.supabase.client.from("investment_transactions").update(e).eq("id",t).select().single();if(n)throw console.error("Error updating transaction:",n),new Error(n.message);return i}async deleteTransaction(t){let{error:e}=await this.supabase.client.from("investment_transactions").delete().eq("id",t);if(e)throw console.error("Error deleting transaction:",e),new Error(e.message)}async getCurrentPrice(t){let{data:e,error:i}=await this.supabase.client.from("investment_current_prices").select("*").eq("ticker",t).single();return i&&i.code!=="PGRST116"?(console.error("Error fetching current price:",i),null):e}async validateTicker(t){try{if(t.includes("."))return{valid:!0,exchangeName:t.split(".")[1],error:void 0};let i=`https://finnhub.io/api/v1/stock/profile2?symbol=${t}&token=${Q.finnhub.apiKey}`,n=await H(this.http.get(i));return!n||!n.ticker?{valid:!1,error:"Ticker not found. For non-US stocks, use format: TICKER.EXCHANGE (e.g., BMW.DE, AIR.PA)"}:{valid:!0,exchangeName:n.exchange}}catch(e){return console.error("Error validating ticker:",e),e.status===429?{valid:!1,error:"Rate limit reached. Please try again later."}:e.status===403||e.error?.message?.includes("access")?{valid:!1,error:"API access denied. Please verify your Finnhub API key in environment.development.ts"}:{valid:!1,error:`Failed to validate ticker: ${e.error?.message||e.message||"Unknown error"}. Try format: TICKER or TICKER.EXCHANGE`}}}async refreshPrice(t){try{if(t.includes(".")){let w=await this.getCurrentPrice(t);if(w)return console.info(`Using cached price for ${t} (Finnhub free tier doesn't support this exchange)`),w;throw new Error(`${t} requires manual price entry. Finnhub free tier doesn't support this exchange.`)}let i=`https://finnhub.io/api/v1/quote?symbol=${t}&token=${Q.finnhub.apiKey}`,n=await H(this.http.get(i));if(!n||n.c===0)throw new Error(`No data available for ${t}. Try format: TICKER or TICKER.EXCHANGE`);let a=`https://finnhub.io/api/v1/stock/profile2?symbol=${t}&token=${Q.finnhub.apiKey}`,g=await H(this.http.get(a)),v={ticker:t.toUpperCase(),price:n.c,currency:g?.currency||"USD",exchange_name:g?.exchange||void 0},{data:D,error:b}=await this.supabase.client.from("investment_current_prices").upsert(v,{onConflict:"ticker"}).select();if(b)throw console.error("Error saving price:",b),new Error(b.message);return D&&D.length>0?D[0]:v}catch(e){if(console.error("Error refreshing price:",e),e.status===429)throw new Error(`Rate limit reached for ${t}. Please try again later.`);if(e.status===403||e.error?.message?.includes("access"))throw new Error(`API access denied for ${t}. Please verify your Finnhub API key.`);let i=e.error?.message||e.message||"Unknown error";throw new Error(`Failed to fetch price for ${t}: ${i}`)}}async getPortfolioSummary(t=!1){try{let{data:e}=await this.getTransactions({pageSize:1e4});if(console.log("\u{1F4BC} Getting portfolio summary, transactions:",e?.length),!e||e.length===0)return console.log("\u26A0\uFE0F No transactions found"),{holdings:[],totalValue:0,totalCost:0,totalGainLoss:0,totalGainLossPercent:0};let i=new Map;for(let u of e){let m=i.get(u.ticker)||{totalQuantity:0,totalCost:0,transactions:[]};if(u.transaction_type==="BUY")m.totalQuantity+=u.quantity,m.totalCost+=u.quantity*u.purchase_price;else if(u.transaction_type==="SELL"){m.totalQuantity-=u.quantity;let V=m.totalCost/(m.totalQuantity+u.quantity);m.totalCost-=u.quantity*V}m.transactions.push(u),i.set(u.ticker,m)}let a=Array.from(i.keys()).map(async u=>{let m=await this.getCurrentPrice(u);if(t||!m||this.isPriceStale(m.last_updated))try{m=await this.refreshPrice(u)}catch(V){let X=V?.message||String(V);if(console.info(`Could not refresh price for ${u}: ${X}`),!m){let P=i.get(u)?.transactions[0];P&&(console.info(`Using last transaction price for ${u}: \u20AC${P.purchase_price}`),m={ticker:u,price:P.purchase_price,currency:"EUR",exchange_name:void 0,last_updated:P.transaction_date})}}return{ticker:u,price:m?.price||0}}),g=await Promise.all(a),v=new Map(g.map(u=>[u.ticker,u.price])),D=[],b=0,w=0;for(let[u,m]of i.entries()){if(m.totalQuantity<=0)continue;let V=v.get(u)||0,X=m.totalCost/m.totalQuantity,G=m.totalQuantity*V,P=G-m.totalCost,Ae=m.totalCost>0?P/m.totalCost*100:0,Y=m.transactions[0]?.ticker?await this.getExchangeForTicker(u):void 0;D.push({ticker:u,totalQuantity:m.totalQuantity,averageCost:X,currentPrice:V,totalCost:m.totalCost,currentValue:G,gainLoss:P,gainLossPercent:Ae,exchange:Y,country:Y?this.mapExchangeToCountry(Y):void 0}),b+=G,w+=m.totalCost}let ie=b-w,Ne=w>0?ie/w*100:0,z={holdings:D.sort((u,m)=>m.currentValue-u.currentValue),totalValue:b,totalCost:w,totalGainLoss:ie,totalGainLossPercent:Ne};return console.log("\u{1F4C8} Portfolio summary calculated:",{holdingsCount:z.holdings.length,totalValue:z.totalValue,totalCost:z.totalCost}),z}catch(e){throw console.error("\u274C Error calculating portfolio summary:",e),e}}async getGeographicalAllocation(t=!1){try{let e=await this.getPortfolioSummary(t);if(!e.holdings||e.holdings.length===0)return[];let i=new Map;for(let a of e.holdings){let g=a.country||"Unknown",v=i.get(g)||0;i.set(g,v+a.currentValue)}let n=[];for(let[a,g]of i.entries())n.push({country:a,value:g,percentage:e.totalValue>0?g/e.totalValue*100:0});return n.sort((a,g)=>g.value-a.value)}catch(e){throw console.error("Error calculating geographical allocation:",e),e}}async getUniqueTickers(){let{data:t,error:e}=await this.supabase.client.from("investment_transactions").select("ticker").order("ticker");return e?(console.error("Error fetching unique tickers:",e),[]):[...new Set(t.map(n=>n.ticker))]}isPriceStale(t){let e=new Date,i=new Date(t);return(e.getTime()-i.getTime())/(1e3*60)>15}async getExchangeForTicker(t){return(await this.getCurrentPrice(t))?.exchange_name}mapExchangeToCountry(t){return Le[t]||"Other"}static \u0275fac=function(e){return new(e||s)(ee(fe),ee(ge))};static \u0275prov=re({token:s,factory:s.\u0275fac,providedIn:"root"})};function ze(s,t){if(s&1){let e=E();r(0,"button",32),y("click",function(){let n=f(e).$implicit,a=d(3);return h(a.selectTickerSuggestion(n))}),c(1),o()}if(s&2){let e=t.$implicit;l(),k(" ",e," ")}}function Ge(s,t){if(s&1&&(r(0,"div",30),C(1,ze,2,1,"button",31),o()),s&2){let e=d(2);l(),p("ngForOf",e.getFilteredSuggestions())}}function He(s,t){s&1&&(r(0,"div",33),S(),r(1,"svg",34),x(2,"circle",35)(3,"path",36),o(),c(4," Validating ticker... "),o())}function qe(s,t){if(s&1&&(r(0,"div",12),c(1),o()),s&2){let e=d(2);l(),k(" ",e.tickerValidationError()," ")}}function Ue(s,t){if(s&1&&(r(0,"div",37),c(1),o()),s&2){let e=d(2);l(),k(" \u2713 Valid ticker (",e.exchangeName(),") ")}}function Re(s,t){if(s&1){let e=E();r(0,"button",38),y("click",function(){f(e);let n=d(2);return h(n.validateTicker())}),c(1," Verify ticker online "),o()}}function Be(s,t){s&1&&(S(),r(0,"svg",39),x(1,"circle",35)(2,"path",36),o())}function $e(s,t){if(s&1){let e=E();r(0,"div",1),y("click",function(){f(e);let n=d();return h(n.close())}),r(1,"div",2),y("click",function(n){return f(e),h(n.stopPropagation())}),r(2,"div",3)(3,"h2",4),c(4),o(),r(5,"button",5),y("click",function(){f(e);let n=d();return h(n.close())}),S(),r(6,"svg",6),x(7,"path",7),o()()(),I(),r(8,"div",8)(9,"form",9)(10,"div",10)(11,"label",11),c(12," Ticker Symbol "),r(13,"span",12),c(14,"*"),o()(),r(15,"input",13),A("ngModelChange",function(n){f(e);let a=d();return N(a.formData.ticker,n)||(a.formData.ticker=n),h(n)}),y("input",function(n){f(e);let a=d();return h(a.onTickerInput(n))})("blur",function(){f(e);let n=d();return h(n.onTickerBlur())}),o(),C(16,Ge,2,1,"div",14),r(17,"div",15),C(18,He,5,0,"div",16)(19,qe,2,1,"div",17)(20,Ue,2,1,"div",18)(21,Re,2,0,"button",19),o()(),r(22,"div")(23,"label",11),c(24," Transaction Type "),r(25,"span",12),c(26,"*"),o()(),r(27,"app-select",20),A("valueChange",function(n){f(e);let a=d();return N(a.formData.transaction_type,n)||(a.formData.transaction_type=n),h(n)}),o()(),r(28,"div")(29,"label",11),c(30," Quantity "),r(31,"span",12),c(32,"*"),o()(),r(33,"input",21),A("ngModelChange",function(n){f(e);let a=d();return N(a.formData.quantity,n)||(a.formData.quantity=n),h(n)}),o()(),r(34,"div")(35,"label",11),c(36," Price per Share (\u20AC) "),r(37,"span",12),c(38,"*"),o()(),r(39,"input",22),A("ngModelChange",function(n){f(e);let a=d();return N(a.formData.purchase_price,n)||(a.formData.purchase_price=n),h(n)}),o(),r(40,"p",23),c(41),o()(),r(42,"div")(43,"label",11),c(44," Transaction Date "),r(45,"span",12),c(46,"*"),o()(),r(47,"input",24),A("ngModelChange",function(n){f(e);let a=d();return N(a.formData.transaction_date,n)||(a.formData.transaction_date=n),h(n)}),o()(),r(48,"div")(49,"label",11),c(50," Notes "),o(),r(51,"textarea",25),A("ngModelChange",function(n){f(e);let a=d();return N(a.formData.notes,n)||(a.formData.notes=n),h(n)}),o()()()(),r(52,"div",26)(53,"button",27),y("click",function(){f(e);let n=d();return h(n.close())}),c(54," Cancel "),o(),r(55,"button",28),y("click",function(){f(e);let n=d();return h(n.save())}),C(56,Be,3,0,"svg",29),r(57,"span"),c(58),o()()()()()}if(s&2){let e=d();l(4),O(e.dialogTitle),l(11),U("border-red-500",e.tickerValidationError())("border-green-500",e.exchangeName()&&!e.tickerValidationError()),M("ngModel",e.formData.ticker),l(),p("ngIf",e.showSuggestions()&&e.getFilteredSuggestions().length>0),l(2),p("ngIf",e.isValidatingTicker()),l(),p("ngIf",e.tickerValidationError()),l(),p("ngIf",e.exchangeName()&&!e.tickerValidationError()),l(),p("ngIf",e.formData.ticker&&!e.isValidatingTicker()),l(6),p("options",e.transactionTypeOptions),M("value",e.formData.transaction_type),l(6),M("ngModel",e.formData.quantity),l(6),M("ngModel",e.formData.purchase_price),l(2),k(" Total: \u20AC",(e.formData.quantity*e.formData.purchase_price).toFixed(2)," "),l(6),M("ngModel",e.formData.transaction_date),l(4),M("ngModel",e.formData.notes),l(2),p("disabled",e.isSaving()),l(2),p("disabled",e.isSaving()||e.isValidatingTicker()||!!e.tickerValidationError()),l(),p("ngIf",e.isSaving()),l(2),O(e.isSaving()?"Saving...":e.isEditMode?"Update":"Add Transaction")}}var K=class s{transaction=null;isOpen=!1;closeDialog=new te;transactionSaved=new te;investmentsService=T(L);notificationService=T(W);formData={ticker:"",quantity:0,purchase_price:0,transaction_date:new Date().toISOString().split("T")[0],transaction_type:"BUY",notes:""};transactionTypeOptions=[{value:"BUY",label:"Buy"},{value:"SELL",label:"Sell"}];isSaving=_(!1);isValidatingTicker=_(!1);tickerValidationError=_(null);exchangeName=_(null);tickerSuggestions=_([]);showSuggestions=_(!1);ngOnInit(){this.loadTickerSuggestions()}ngOnChanges(){this.isOpen&&(this.transaction?this.formData={ticker:this.transaction.ticker||"",quantity:this.transaction.quantity||0,purchase_price:this.transaction.purchase_price||0,transaction_date:this.transaction.transaction_date?new Date(this.transaction.transaction_date).toISOString().split("T")[0]:new Date().toISOString().split("T")[0],transaction_type:this.transaction.transaction_type||"BUY",notes:this.transaction.notes||""}:this.formData={ticker:"",quantity:0,purchase_price:0,transaction_date:new Date().toISOString().split("T")[0],transaction_type:"BUY",notes:""},this.tickerValidationError.set(null),this.exchangeName.set(null))}async loadTickerSuggestions(){let t=await this.investmentsService.getUniqueTickers();this.tickerSuggestions.set(t)}onTickerInput(t){let e=t.target.value.toUpperCase();this.formData.ticker=e,this.tickerValidationError.set(null),this.exchangeName.set(null),this.showSuggestions.set(e.length>0)}selectTickerSuggestion(t){this.formData.ticker=t,this.showSuggestions.set(!1)}onTickerBlur(){setTimeout(()=>{this.showSuggestions.set(!1)},200)}async validateTicker(){if(!this.formData.ticker){this.tickerValidationError.set("Ticker is required");return}this.isValidatingTicker.set(!0),this.tickerValidationError.set(null),this.exchangeName.set(null);try{let t=await this.investmentsService.validateTicker(this.formData.ticker);t.valid?this.exchangeName.set(t.exchangeName||null):(this.tickerValidationError.set(t.error||"Invalid ticker"),this.exchangeName.set(null))}catch(t){console.error("Error validating ticker:",t),this.tickerValidationError.set("Failed to validate ticker"),this.exchangeName.set(null)}finally{this.isValidatingTicker.set(!1)}}getFilteredSuggestions(){let t=this.formData.ticker.toUpperCase();return t?this.tickerSuggestions().filter(e=>e.toUpperCase().includes(t)):[]}close(){this.closeDialog.emit(),this.resetForm()}resetForm(){this.formData={ticker:"",quantity:0,purchase_price:0,transaction_date:new Date().toISOString().split("T")[0],transaction_type:"BUY",notes:""},this.tickerValidationError.set(null),this.exchangeName.set(null),this.showSuggestions.set(!1)}validateForm(){return this.formData.ticker?!this.formData.quantity||this.formData.quantity<=0?(this.notificationService.error("Quantity must be greater than 0"),!1):!this.formData.purchase_price||this.formData.purchase_price<0?(this.notificationService.error("Price must be 0 or greater"),!1):this.formData.transaction_date?!0:(this.notificationService.error("Transaction date is required"),!1):(this.notificationService.error("Ticker is required"),!1)}async save(){if(this.validateForm()){this.isSaving.set(!0);try{let t={ticker:this.formData.ticker.toUpperCase(),quantity:this.formData.quantity,purchase_price:this.formData.purchase_price,transaction_date:this.formData.transaction_date,transaction_type:this.formData.transaction_type,notes:this.formData.notes||void 0};this.transaction?(await this.investmentsService.updateTransaction(this.transaction.id,t),this.notificationService.success("Transaction updated successfully")):(await this.investmentsService.createTransaction(t),this.notificationService.success("Transaction added successfully")),this.transactionSaved.emit(),this.close()}catch(t){console.error("Error saving transaction:",t),this.notificationService.error(t.message||"Failed to save transaction")}finally{this.isSaving.set(!1)}}}get isEditMode(){return!!this.transaction}get dialogTitle(){return this.isEditMode?"Edit Transaction":"Add Transaction"}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=q({type:s,selectors:[["app-investment-dialog"]],inputs:{transaction:"transaction",isOpen:"isOpen"},outputs:{closeDialog:"closeDialog",transactionSaved:"transactionSaved"},features:[ae],decls:1,vars:1,consts:[["class","fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in",3,"click",4,"ngIf"],[1,"fixed","inset-0","bg-black/70","backdrop-blur-sm","z-50","flex","items-center","justify-center","p-4","animate-fade-in",3,"click"],[1,"bg-zinc-900","rounded-lg","border","border-zinc-800","shadow-2xl","max-w-2xl","w-full","max-h-[85vh]","md:max-h-[90vh]","overflow-hidden","animate-scale-in",3,"click"],[1,"px-6","py-4","border-b","border-zinc-800","flex","items-center","justify-between","bg-zinc-900/50"],[1,"text-xl","font-semibold","text-white"],[1,"text-zinc-400","hover:text-white","transition-colors","p-1","hover:bg-zinc-800","rounded",3,"click"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M6 18L18 6M6 6l12 12"],[1,"px-6","py-6","overflow-y-auto","max-h-[calc(90vh-140px)]"],[1,"space-y-5"],[1,"relative"],[1,"block","text-sm","font-medium","text-zinc-300","mb-2"],[1,"text-red-400"],["type","text","name","ticker","placeholder","e.g., AAPL, MSFT, NVDA",1,"w-full","px-4","py-2.5","bg-zinc-950","border","border-zinc-700","rounded-md","text-zinc-200","placeholder-zinc-500","focus:outline-none","focus:border-brand","focus:ring-1","focus:ring-brand","transition-colors","uppercase",3,"ngModelChange","input","blur","ngModel"],["class","absolute z-10 w-full mt-1 bg-zinc-800 border border-zinc-700 rounded-md shadow-lg max-h-48 overflow-y-auto",4,"ngIf"],[1,"mt-1","text-sm"],["class","flex items-center text-zinc-400",4,"ngIf"],["class","text-red-400",4,"ngIf"],["class","text-green-400",4,"ngIf"],["type","button","class","mt-1 text-xs text-blue-400 hover:text-blue-300",3,"click",4,"ngIf"],["placeholder","Select transaction type",3,"valueChange","options","value"],["type","number","name","quantity","placeholder","0.00","step","0.01","min","0",1,"w-full","px-4","py-2.5","bg-zinc-950","border","border-zinc-700","rounded-md","text-zinc-200","placeholder-zinc-500","focus:outline-none","focus:border-brand","focus:ring-1","focus:ring-brand","transition-colors",3,"ngModelChange","ngModel"],["type","number","name","purchase_price","placeholder","0.00","step","0.01","min","0",1,"w-full","px-4","py-2.5","bg-zinc-950","border","border-zinc-700","rounded-md","text-zinc-200","placeholder-zinc-500","focus:outline-none","focus:border-brand","focus:ring-1","focus:ring-brand","transition-colors",3,"ngModelChange","ngModel"],[1,"text-xs","text-zinc-500","mt-1"],["type","date","name","transaction_date",1,"w-full","px-4","py-2.5","bg-zinc-950","border","border-zinc-700","rounded-md","text-zinc-200","focus:outline-none","focus:border-brand","focus:ring-1","focus:ring-brand","transition-colors",3,"ngModelChange","ngModel"],["name","notes","rows","3","placeholder","Additional notes about this transaction...",1,"w-full","px-4","py-2.5","bg-zinc-950","border","border-zinc-700","rounded-md","text-zinc-200","placeholder-zinc-500","focus:outline-none","focus:border-brand","focus:ring-1","focus:ring-brand","transition-colors","resize-none",3,"ngModelChange","ngModel"],[1,"px-6","py-4","border-t","border-zinc-800","flex","justify-end","gap-3","bg-zinc-900/50"],["type","button",1,"px-4","py-2","text-zinc-300","hover:text-white","border","border-zinc-700","hover:bg-zinc-800","rounded-md","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],["type","button",1,"px-6","py-2","bg-green-600","hover:bg-green-700","text-white","rounded-md","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed","flex","items-center","gap-2",3,"click","disabled"],["class","animate-spin h-4 w-4","fill","none","viewBox","0 0 24 24","stroke","currentColor",4,"ngIf"],[1,"absolute","z-10","w-full","mt-1","bg-zinc-800","border","border-zinc-700","rounded-md","shadow-lg","max-h-48","overflow-y-auto"],["type","button","class","w-full px-4 py-2 text-left text-zinc-200 hover:bg-zinc-700 transition-colors",3,"click",4,"ngFor","ngForOf"],["type","button",1,"w-full","px-4","py-2","text-left","text-zinc-200","hover:bg-zinc-700","transition-colors",3,"click"],[1,"flex","items-center","text-zinc-400"],["fill","none","viewBox","0 0 24 24",1,"animate-spin","h-4","w-4","mr-2"],["cx","12","cy","12","r","10","stroke","currentColor","stroke-width","4",1,"opacity-25"],["fill","currentColor","d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z",1,"opacity-75"],[1,"text-green-400"],["type","button",1,"mt-1","text-xs","text-blue-400","hover:text-blue-300",3,"click"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"animate-spin","h-4","w-4"]],template:function(e,i){e&1&&C(0,$e,59,22,"div",0),e&2&&p("ngIf",i.isOpen)},dependencies:[$,pe,B,j,be,he,Ce,ve,_e,we,ye,xe,Se],encapsulation:2})};var Qe=["headerActions"],je=()=>[];function We(s,t){if(s&1){let e=E();r(0,"div",7)(1,"button",8),y("click",function(){f(e);let n=d();return h(n.refreshPrices())}),S(),r(2,"svg",9),x(3,"path",10),o(),I(),r(4,"span",11),c(5),o()(),r(6,"button",12),y("click",function(){f(e);let n=d();return h(n.openAddDialog())}),S(),r(7,"svg",9),x(8,"path",13),o(),I(),r(9,"span",11),c(10,"Add Transaction"),o()()()}if(s&2){let e=d();l(),p("disabled",e.isRefreshing()),l(),U("animate-spin",e.isRefreshing()),l(3),O(e.isRefreshing()?"Updating...":"Update Prices")}}function Ke(s,t){s&1&&(r(0,"div",14),x(1,"div",15),o())}function Xe(s,t){if(s&1&&(r(0,"div",40),c(1),o()),s&2){let e=d(2);l(),k(" Last updated: ",e.lastUpdated().toLocaleString("it-IT")," ")}}function Ye(s,t){if(s&1&&(r(0,"div"),x(1,"apx-chart",41),o()),s&2){let e=d(2);l(),p("series",e.compositionChartOptions.series)("chart",e.compositionChartOptions.chart)("labels",e.compositionChartOptions.labels)("colors",e.compositionChartOptions.colors)("legend",e.compositionChartOptions.legend)("dataLabels",e.compositionChartOptions.dataLabels)("tooltip",e.compositionChartOptions.tooltip)}}function Je(s,t){if(s&1&&(r(0,"div"),x(1,"apx-chart",42),o()),s&2){let e=d(2);l(),p("series",e.geographicalChartOptions.series)("chart",e.geographicalChartOptions.chart)("colors",e.geographicalChartOptions.colors)("legend",e.geographicalChartOptions.legend)("dataLabels",e.geographicalChartOptions.dataLabels)("tooltip",e.geographicalChartOptions.tooltip)}}function Ze(s,t){if(s&1){let e=E();r(0,"div")(1,"div",16)(2,"div",17)(3,"div",18)(4,"div",19)(5,"div",20),S(),r(6,"svg",21),x(7,"path",22),o()(),I(),r(8,"div",23)(9,"dl")(10,"dt",24),c(11,"Total Portfolio Value"),o(),r(12,"dd")(13,"div",25),c(14),o()()()()(),C(15,Xe,2,1,"div",26),o()(),r(16,"div",17)(17,"div",18)(18,"div",19)(19,"div",20),S(),r(20,"svg",27),x(21,"path",28),o()(),I(),r(22,"div",23)(23,"dl")(24,"dt",24),c(25,"Total Gain/Loss"),o(),r(26,"dd")(27,"div",29),c(28),o()()()()()()(),r(29,"div",17)(30,"div",18)(31,"div",19)(32,"div",20),S(),r(33,"svg",27),x(34,"path",30),o()(),I(),r(35,"div",23)(36,"dl")(37,"dt",24),c(38,"Return on Investment"),o(),r(39,"dd")(40,"div",29),c(41),o()()()()()()()(),r(42,"div",31)(43,"div",17)(44,"div",18)(45,"h3",32),c(46,"Portfolio Composition"),o(),C(47,Ye,2,7,"div",33),o()(),r(48,"div",17)(49,"div",18)(50,"h3",32),c(51,"Geographical Allocation"),o(),C(52,Je,2,6,"div",33),o()()(),r(53,"div",34)(54,"h3",25),c(55,"Current Holdings"),o(),r(56,"div",35),x(57,"app-data-table",36),o()(),r(58,"div",37)(59,"h3",25),c(60,"Transaction History"),o(),r(61,"div",38)(62,"app-data-table",39),y("cellClicked",function(n){f(e);let a=d();return h(a.onCellClicked(n))}),o()()()()}if(s&2){let e,i,n,a=d(),g=de(6);l(14),k(" ",a.formatCurrency(a.totalValue())," "),l(),p("ngIf",a.lastUpdated()),l(5),F(a.totalGainLoss()>=0?"text-green-500":"text-red-500"),l(),oe("d",a.totalGainLoss()>=0?"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6":"M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"),l(6),F(a.getGainLossColor(a.totalGainLoss())),l(),k(" ",a.formatCurrency(a.totalGainLoss())," "),l(5),F(a.totalGainLossPercent()>=0?"text-green-500":"text-red-500"),l(7),F(a.getGainLossColor(a.totalGainLossPercent())),l(),k(" ",a.formatPercent(a.totalGainLossPercent())," "),l(6),p("ngIf",(((e=a.portfolioSummary())==null||e.holdings==null?null:e.holdings.length)??0)>0)("ngIfElse",g),l(5),p("ngIf",a.geographicalAllocation().length>0)("ngIfElse",g),l(5),p("columnDefs",a.portfolioColumnDefs)("rowData",((i=a.portfolioSummary())==null?null:i.holdings)||me(30,je))("loading",a.isLoading())("showPagination",!1)("showFilters",!1)("totalRecords",((n=a.portfolioSummary())==null||n.holdings==null?null:n.holdings.length)||0),l(5),p("columnDefs",a.transactionsColumnDefs)("rowData",a.transactions())("loading",a.isLoading())("showPagination",!0)("showFilters",!1)("pageSize",20)("totalRecords",a.transactions().length)}}function et(s,t){s&1&&(r(0,"div",43),S(),r(1,"svg",44),x(2,"path",30),o(),I(),r(3,"p",45),c(4,"No investment data yet"),o(),r(5,"p",46),c(6,"Start tracking your investments by adding a transaction"),o()())}function tt(s,t){if(s&1){let e=E();r(0,"app-confirmation-dialog",47),y("confirm",function(){f(e);let n=d();return h(n.confirmDelete())})("cancel",function(){f(e);let n=d();return h(n.cancelDelete())}),o()}if(s&2){let e=d();p("isOpen",e.isConfirmDialogOpen)("title",e.confirmDialogTitle)("message",e.confirmDialogMessage)}}function nt(s,t){if(s&1){let e=E();r(0,"app-investment-dialog",48),y("closeDialog",function(){f(e);let n=d();return h(n.onDialogClose())})("transactionSaved",function(){f(e);let n=d();return h(n.onDialogClose())}),o()}if(s&2){let e=d();p("isOpen",e.showInvestmentDialog())("transaction",e.editingTransaction())}}var Me=class s{headerActionsTemplate;investmentsService=T(L);notificationService=T(W);pageHeaderService=T(ke);pageHeaderActionsService=T(De);cd=T(ue);portfolioSummary=_(null);geographicalAllocation=_([]);transactions=_([]);isLoading=_(!0);isRefreshing=_(!1);lastUpdated=_(null);totalValue=R(()=>this.portfolioSummary()?.totalValue??0);totalGainLoss=R(()=>this.portfolioSummary()?.totalGainLoss??0);totalGainLossPercent=R(()=>this.portfolioSummary()?.totalGainLossPercent??0);showInvestmentDialog=_(!1);editingTransaction=_(null);isConfirmDialogOpen=!1;confirmDialogTitle="";confirmDialogMessage="";pendingDeleteTransaction=null;portfolioColumnDefs=[{field:"ticker",headerName:"Ticker",sortable:!0,filter:!0,width:120},{field:"totalQuantity",headerName:"Quantity",sortable:!0,width:120,valueFormatter:t=>t.value?.toFixed(2)??"0"},{field:"averageCost",headerName:"Avg Cost",sortable:!0,width:120,valueFormatter:t=>`\u20AC${t.value?.toFixed(2)??"0"}`},{field:"currentPrice",headerName:"Current Price",sortable:!0,width:140,valueFormatter:t=>`\u20AC${t.value?.toFixed(2)??"0"}`},{field:"currentValue",headerName:"Value",sortable:!0,width:130,valueFormatter:t=>`\u20AC${t.value?.toFixed(2)??"0"}`},{field:"gainLoss",headerName:"Gain/Loss",sortable:!0,width:140,cellStyle:t=>t.value>=0?{color:"#22c55e"}:{color:"#ef4444"},valueFormatter:t=>{let e=t.value??0;return`\u20AC${e>=0?"+":""}${e.toFixed(2)}`}},{field:"gainLossPercent",headerName:"Gain/Loss %",sortable:!0,width:140,cellStyle:t=>t.value>=0?{color:"#22c55e"}:{color:"#ef4444"},valueFormatter:t=>{let e=t.value??0;return`${e>=0?"+":""}${e.toFixed(2)}%`}},{field:"country",headerName:"Country",sortable:!0,filter:!0,width:120}];transactionsColumnDefs=[{field:"transaction_date",headerName:"Date",sortable:!0,width:120,valueFormatter:t=>t.value?new Date(t.value).toLocaleDateString("it-IT"):""},{field:"ticker",headerName:"Ticker",sortable:!0,filter:!0,width:120},{field:"transaction_type",headerName:"Type",sortable:!0,filter:!0,width:100,cellStyle:t=>t.value==="BUY"?{color:"#22c55e"}:{color:"#ef4444"}},{field:"quantity",headerName:"Quantity",sortable:!0,width:120,valueFormatter:t=>t.value?.toFixed(2)??"0"},{field:"purchase_price",headerName:"Price",sortable:!0,width:120,valueFormatter:t=>`\u20AC${t.value?.toFixed(2)??"0"}`},{headerName:"Total",sortable:!0,width:130,valueGetter:t=>{let e=t.data?.quantity??0,i=t.data?.purchase_price??0;return e*i},valueFormatter:t=>`\u20AC${t.value?.toFixed(2)??"0"}`},{field:"notes",headerName:"Notes",filter:!0,flex:1,minWidth:150},{headerName:"Actions",width:120,cellRenderer:t=>{let e=document.createElement("div");e.className="flex gap-2";let i=document.createElement("button");i.innerHTML=`<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>`,i.className="text-blue-400 hover:text-blue-300",i.onclick=()=>this.editTransaction(t.data);let n=document.createElement("button");return n.innerHTML=`<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>`,n.className="text-red-400 hover:text-red-300",n.onclick=()=>this.deleteTransaction(t.data),e.appendChild(i),e.appendChild(n),e}}];compositionChartOptions={chart:{type:"donut",height:350,background:"transparent",foreColor:"#e5e7eb"},labels:[],series:[],colors:["#22c55e","#3b82f6","#f59e0b","#ef4444","#8b5cf6","#ec4899","#06b6d4","#84cc16"],legend:{position:"bottom",labels:{colors:"#e5e7eb"}},dataLabels:{enabled:!0,formatter:t=>`${t.toFixed(1)}%`},tooltip:{theme:"dark",y:{formatter:t=>`\u20AC${t.toFixed(2)}`}}};geographicalChartOptions={chart:{type:"treemap",height:350,background:"transparent",foreColor:"#e5e7eb",toolbar:{show:!1}},series:[],colors:["#22c55e"],legend:{show:!1},dataLabels:{enabled:!0,style:{fontSize:"14px",colors:["#ffffff"]},formatter:(t,e)=>[t,`${e.value.toFixed(1)}%`]},tooltip:{theme:"dark",y:{formatter:(t,e)=>{let i=e.w.config.series[0].data[e.dataPointIndex].x;return`\u20AC${this.geographicalAllocation().find(a=>a.country===i)?.value.toFixed(2)??"0"}`}}}};ngOnInit(){this.pageHeaderService.setHeader("Investments"),this.loadData()}ngAfterViewInit(){this.pageHeaderActionsService.setActions(this.headerActionsTemplate),this.cd.detectChanges()}ngOnDestroy(){this.pageHeaderActionsService.clearActions()}async loadData(t=!1){try{this.isLoading.set(!0),console.log("\u{1F504} Loading investment data...");let[e,i,n]=await Promise.all([this.investmentsService.getPortfolioSummary(t),this.investmentsService.getGeographicalAllocation(t),this.investmentsService.getTransactions({pageSize:1e3})]);console.log("\u2705 Data loaded:",{portfolioSummary:e,geographicalAllocation:i,transactions:n.data}),this.portfolioSummary.set(e),this.geographicalAllocation.set(i),this.transactions.set(n.data),console.log("\u{1F4CA} Signals updated:",{portfolioHoldings:this.portfolioSummary()?.holdings?.length,portfolioFirstHolding:this.portfolioSummary()?.holdings?.[0],transactions:this.transactions().length,transactionFirst:this.transactions()?.[0],geoAllocation:this.geographicalAllocation().length}),this.cd.detectChanges(),this.updateCharts(),t&&this.lastUpdated.set(new Date)}catch(e){console.error("\u274C Error loading investments data:",e),this.notificationService.error("Failed to load investments data")}finally{this.isLoading.set(!1)}}async refreshPrices(){try{this.isRefreshing.set(!0);let t=this.portfolioSummary();if(!t||t.holdings.length===0){this.notificationService.info("No holdings to refresh");return}let e=t.holdings.map(a=>a.ticker);this.notificationService.info(`Updating prices for ${e.length} ticker(s)...`);let i=0,n=0;for(let a of e)try{await this.investmentsService.refreshPrice(a),i++,await new Promise(g=>setTimeout(g,500))}catch(g){if(console.error(`Failed to refresh ${a}:`,g),n++,g.message?.includes("429")||g.message?.includes("Too Many Requests")){this.notificationService.error("Rate limit reached. Please try again later or enter prices manually.");break}}await this.loadData(!0),i>0?this.notificationService.success(`${i} price(s) updated successfully${n>0?`, ${n} failed`:""}`):n>0&&this.notificationService.error("Failed to update prices. Try entering them manually.")}catch(t){console.error("Error refreshing prices:",t),this.notificationService.error("Failed to refresh prices")}finally{this.isRefreshing.set(!1)}}updateCharts(){let t=this.portfolioSummary(),e=this.geographicalAllocation();t&&t.holdings.length>0&&(this.compositionChartOptions=Z(J({},this.compositionChartOptions),{labels:t.holdings.map(i=>i.ticker),series:t.holdings.map(i=>i.currentValue)}),e.length>0&&(this.geographicalChartOptions=Z(J({},this.geographicalChartOptions),{series:[{data:e.map(i=>({x:i.country,y:i.percentage}))}]})))}openAddDialog(){this.editingTransaction.set(null),this.showInvestmentDialog.set(!0)}editTransaction(t){this.editingTransaction.set(t),this.showInvestmentDialog.set(!0)}onCellClicked(t){console.log("Cell clicked:",t)}deleteTransaction(t){this.pendingDeleteTransaction=t,this.confirmDialogTitle="Delete Transaction",this.confirmDialogMessage=`Are you sure you want to delete this ${t.transaction_type} transaction for ${t.ticker}?`,this.isConfirmDialogOpen=!0}async confirmDelete(){if(this.pendingDeleteTransaction)try{await this.investmentsService.deleteTransaction(this.pendingDeleteTransaction.id),this.notificationService.success("Transaction deleted successfully"),await this.loadData()}catch(t){console.error("Error deleting transaction:",t),this.notificationService.error("Failed to delete transaction")}finally{this.isConfirmDialogOpen=!1,this.pendingDeleteTransaction=null}}cancelDelete(){this.isConfirmDialogOpen=!1,this.pendingDeleteTransaction=null}onDialogClose(){this.showInvestmentDialog.set(!1),this.editingTransaction.set(null),this.loadData()}formatCurrency(t){return`\u20AC${t.toFixed(2)}`}formatPercent(t){return`${t>=0?"+":""}${t.toFixed(2)}%`}getGainLossColor(t){return t>=0?"text-green-500":"text-red-500"}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=q({type:s,selectors:[["app-investments"]],viewQuery:function(e,i){if(e&1&&se(Qe,5),e&2){let n;le(n=ce())&&(i.headerActionsTemplate=n.first)}},decls:9,vars:4,consts:[["headerActions",""],["noData",""],[1,"container","mx-auto","p-6","space-y-6"],["class","flex items-center justify-center h-64",4,"ngIf"],[4,"ngIf"],[3,"isOpen","title","message","confirm","cancel",4,"ngIf"],[3,"isOpen","transaction","closeDialog","transactionSaved",4,"ngIf"],[1,"flex","gap-2"],[1,"flex","items-center","justify-center","gap-2","px-2","sm:px-4","py-2.5","h-10","text-sm","bg-zinc-800","text-white","rounded-lg","hover:bg-zinc-700","transition-colors","border","border-zinc-700","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"h-5","w-5","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"],[1,"hidden","sm:inline","whitespace-nowrap"],[1,"flex","items-center","justify-center","gap-2","px-2","sm:px-4","py-2.5","h-10","text-sm","bg-brand","text-black","font-medium","rounded-lg","hover:bg-brand/90","transition-colors",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],[1,"flex","items-center","justify-center","h-64"],[1,"animate-spin","rounded-full","h-12","w-12","border-b-2","border-green-500"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-5","mb-6"],[1,"overflow-hidden","rounded-lg","bg-background-card","shadow","border","border-sidebar-border"],[1,"p-5"],[1,"flex","items-center"],[1,"flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-blue-500"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"ml-5","w-0","flex-1"],[1,"truncate","text-sm","font-medium","text-slate-400"],[1,"text-lg","font-semibold","text-white"],["class","text-xs text-slate-500 mt-3",4,"ngIf"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2"],[1,"text-lg","font-semibold"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"],[1,"grid","grid-cols-1","lg:grid-cols-2","gap-5","mb-6"],[1,"text-lg","font-semibold","text-white","mb-4"],[4,"ngIf","ngIfElse"],[1,"mb-12",2,"height","40rem"],[2,"height","10px","display","block","position","relative"],["emptyStateMessage","No holdings yet. Add your first investment transaction to get started.",3,"columnDefs","rowData","loading","showPagination","showFilters","totalRecords"],[1,"mb-16"],[2,"height","600px","display","block","position","relative"],["emptyStateMessage","No transactions yet. Add your first investment to get started.",3,"cellClicked","columnDefs","rowData","loading","showPagination","showFilters","pageSize","totalRecords"],[1,"text-xs","text-slate-500","mt-3"],[3,"series","chart","labels","colors","legend","dataLabels","tooltip"],[3,"series","chart","colors","legend","dataLabels","tooltip"],[1,"text-center","py-12","text-gray-400"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","mx-auto","mb-4","text-gray-600"],[1,"text-lg","font-medium","mb-2"],[1,"text-sm"],[3,"confirm","cancel","isOpen","title","message"],[3,"closeDialog","transactionSaved","isOpen","transaction"]],template:function(e,i){e&1&&(r(0,"div",2),C(1,We,11,4,"ng-template",null,0,ne)(3,Ke,2,0,"div",3)(4,Ze,63,31,"div",4)(5,et,7,0,"ng-template",null,1,ne),o(),C(7,tt,1,3,"app-confirmation-dialog",5)(8,nt,1,2,"app-investment-dialog",6)),e&2&&(l(3),p("ngIf",i.isLoading()),l(),p("ngIf",!i.isLoading()),l(3),p("ngIf",i.isConfirmDialogOpen),l(),p("ngIf",i.showInvestmentDialog()))},dependencies:[$,B,j,Ie,Te,Ee,Ve,K],encapsulation:2})};export{Me as InvestmentsComponent};
