name: Monthly Email Report

# Runs on the first day of every month at 08:00 UTC (09:00 CET / 10:00 CEST+1)
on:
  schedule:
    - cron: '0 8 1 * *'  # First day of month at 08:00 UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  send-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call Supabase Edge Function
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Calling send-monthly-report Edge Function..."
          
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST \
            "${SUPABASE_URL}/functions/v1/send-monthly-report" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json")
          
          HTTP_BODY=$(echo "$RESPONSE" | sed -e 's/HTTP_STATUS\:.*//g')
          HTTP_STATUS=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTP_STATUS://')
          
          echo "Response Status: $HTTP_STATUS"
          echo "Response Body: $HTTP_BODY"
          
          # Pretty print JSON if jq is available
          if command -v jq &> /dev/null; then
            echo "$HTTP_BODY" | jq .
          fi
          
          # Check if request was successful
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Error: Edge Function returned status $HTTP_STATUS"
            exit 1
          fi
          
          echo "✅ Monthly report sent successfully"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Failed to send monthly report"
          echo "Check the logs above for details"
