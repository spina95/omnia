import{a as Me}from"./chunk-33ELOFNQ.js";import{a as Ee,b as Te}from"./chunk-S55UVCW6.js";import{a as ue,b as ye}from"./chunk-6ZAMJEQR.js";import"./chunk-QPMMAPE7.js";import{a as De,b as Se}from"./chunk-V2ZT7OKQ.js";import{a as ke}from"./chunk-26BZFXEB.js";import{a as _e}from"./chunk-OKJ7GLF5.js";import{a as we}from"./chunk-7PC7RWUX.js";import{a as be,d as fe,g as ve,r as Ce}from"./chunk-AM3HY3WI.js";import{Ab as U,Bb as W,Cb as Y,Eb as me,Fb as ne,Ia as j,K as ae,L as ie,Ma as G,Mb as pe,Ob as K,P as re,Q as ee,Qa as M,Tb as he,W as R,Wa as y,X as z,Xa as r,Y as F,Ya as o,Z as A,Za as C,ca as oe,da as se,eb as te,ec as Q,fb as w,fc as ge,hb as D,la as le,mc as q,qb as ce,rb as B,sb as V,sc as xe,tb as de,vb as d,wb as H,xb as E,yb as J,za as l}from"./chunk-ELVZURTH.js";import{a as N,b as $}from"./chunk-VOSPIT4N.js";function Fe(m,e){if(m&1&&(r(0,"div",15),C(1,"div",16),r(2,"div",17),d(3),o()()),m&2){let n=e.$implicit;B("left",n.position,"%"),l(3),H(n.year)}}var Z=class m{minDate="2022-01-01";maxDate=new Date().toISOString().split("T")[0];rangeChange=new oe;startPosition=0;endPosition=100;_startDate="";_endDate="";totalDays=0;minDateMs=0;maxDateMs=0;yearMarkers=[];isDraggingStart=!1;isDraggingEnd=!1;trackElement=null;onChange=e=>{};onTouched=()=>{};ngOnInit(){this.initializeTimeline()}ngOnChanges(e){(e.minDate||e.maxDate)&&this.initializeTimeline()}initializeTimeline(){this.minDateMs=new Date(this.minDate).getTime(),this.maxDateMs=new Date(this.maxDate).getTime(),this.totalDays=Math.floor((this.maxDateMs-this.minDateMs)/(1e3*60*60*24)),this.calculateYearMarkers(),(!this._startDate||!this._endDate)&&(this._startDate=this.minDate,this._endDate=this.maxDate,this.startPosition=0,this.endPosition=100)}calculateYearMarkers(){let e=[],n=new Date(this.minDate).getFullYear(),t=new Date(this.maxDate).getFullYear();for(let i=n;i<=t;i++){let s=new Date(i,0,1).getTime();if(s>=this.minDateMs&&s<=this.maxDateMs){let c=(s-this.minDateMs)/(this.maxDateMs-this.minDateMs)*100;e.push({position:c,year:i})}}this.yearMarkers=e}writeValue(e){e&&e.startDate&&e.endDate&&(this._startDate=e.startDate,this._endDate=e.endDate,this.updatePositionsFromDates())}registerOnChange(e){this.onChange=e}registerOnTouched(e){this.onTouched=e}updatePositionsFromDates(){let e=new Date(this._startDate).getTime(),n=new Date(this._endDate).getTime();this.startPosition=(e-this.minDateMs)/(this.maxDateMs-this.minDateMs)*100,this.endPosition=(n-this.minDateMs)/(this.maxDateMs-this.minDateMs)*100,this.startPosition=Math.max(0,Math.min(100,this.startPosition)),this.endPosition=Math.max(0,Math.min(100,this.endPosition))}updateDatesFromPositions(){let e=this.minDateMs+this.startPosition/100*(this.maxDateMs-this.minDateMs),n=this.minDateMs+this.endPosition/100*(this.maxDateMs-this.minDateMs);this._startDate=this.formatDate(new Date(e)),this._endDate=this.formatDate(new Date(n))}formatDate(e){let n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${n}-${t}-${i}`}onStartThumbMouseDown(e){e.preventDefault(),this.isDraggingStart=!0,this.trackElement=e.target.closest(".timeline-container"),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}onEndThumbMouseDown(e){e.preventDefault(),this.isDraggingEnd=!0,this.trackElement=e.target.closest(".timeline-container"),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}onMouseMove=e=>{if(!this.isDraggingStart&&!this.isDraggingEnd||!this.trackElement)return;let n=this.trackElement.querySelector(".timeline-track");if(!n)return;let t=n.getBoundingClientRect(),i=e.clientX-t.left,a=Math.max(0,Math.min(100,i/t.width*100));this.isDraggingStart?(this.startPosition=Math.min(a,this.endPosition),this.updateDatesFromPositions(),this.emitChange()):this.isDraggingEnd&&(this.endPosition=Math.max(a,this.startPosition),this.updateDatesFromPositions(),this.emitChange())};onMouseUp=()=>{this.isDraggingStart=!1,this.isDraggingEnd=!1,this.trackElement=null,document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)};onTrackClick(e){if(this.isDraggingStart||this.isDraggingEnd)return;let t=e.currentTarget.getBoundingClientRect(),i=e.clientX-t.left,a=Math.max(0,Math.min(100,i/t.width*100)),s=Math.abs(a-this.startPosition),c=Math.abs(a-this.endPosition);s<c?this.startPosition=Math.min(a,this.endPosition):this.endPosition=Math.max(a,this.startPosition),this.updateDatesFromPositions(),this.emitChange()}ngOnDestroy(){document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}emitChange(){let e={startDate:this._startDate,endDate:this._endDate};this.onChange(e),this.rangeChange.emit(e),this.onTouched()}get startDate(){return this._startDate}get endDate(){return this._endDate}get selectedRangeWidth(){return this.endPosition-this.startPosition}get selectedRangeLeft(){return this.startPosition}formatDisplayDate(e){if(!e)return"";let n=new Date(e),t={year:"numeric",month:"short",day:"numeric"};return n.toLocaleDateString("en-US",t)}static \u0275fac=function(n){return new(n||m)};static \u0275cmp=G({type:m,selectors:[["app-date-range-timeline"]],inputs:{minDate:"minDate",maxDate:"maxDate"},outputs:{rangeChange:"rangeChange"},features:[me([{provide:be,useExisting:ae(()=>m),multi:!0}]),le],decls:20,vars:11,consts:[[1,"date-range-timeline"],[1,"flex","justify-between","items-center","mb-2"],[1,"text-xs","text-zinc-400"],[1,"text-brand","font-medium"],[1,"text-xs","text-zinc-500"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"w-3","h-3","inline-block"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"],[1,"timeline-container"],[1,"year-markers"],["class","year-marker",3,"left",4,"ngFor","ngForOf"],[1,"timeline-track",3,"click"],[1,"selected-range"],[1,"timeline-thumb","start-thumb",3,"mousedown"],[1,"thumb-circle"],[1,"timeline-thumb","end-thumb",3,"mousedown"],[1,"year-marker"],[1,"year-tick"],[1,"year-label"]],template:function(n,t){n&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"span",3),d(4),o()(),r(5,"div",4),F(),r(6,"svg",5),C(7,"path",6),o()(),A(),r(8,"div",2)(9,"span",3),d(10),o()()(),r(11,"div",7)(12,"div",8),M(13,Fe,4,3,"div",9),o(),r(14,"div",10),w("click",function(a){return t.onTrackClick(a)}),C(15,"div",11),r(16,"div",12),w("mousedown",function(a){return t.onStartThumbMouseDown(a)}),C(17,"div",13),o(),r(18,"div",14),w("mousedown",function(a){return t.onEndThumbMouseDown(a)}),C(19,"div",13),o()()()()),n&2&&(l(4),H(t.formatDisplayDate(t.startDate)),l(6),H(t.formatDisplayDate(t.endDate)),l(3),y("ngForOf",t.yearMarkers),l(2),B("left",t.selectedRangeLeft,"%")("width",t.selectedRangeWidth,"%"),l(),B("left",t.startPosition,"%"),l(2),B("left",t.endPosition,"%"))},dependencies:[q,Q],styles:[".date-range-timeline[_ngcontent-%COMP%]{width:100%;padding:8px 0}.timeline-container[_ngcontent-%COMP%]{position:relative;height:50px;padding:8px 0}.year-markers[_ngcontent-%COMP%]{position:absolute;top:0;left:0;right:0;height:20px;pointer-events:none}.year-marker[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%)}.year-tick[_ngcontent-%COMP%]{width:1px;height:8px;background-color:#52525b;margin:0 auto}.year-label[_ngcontent-%COMP%]{font-size:10px;color:#71717a;text-align:center;margin-top:2px;white-space:nowrap}.timeline-track[_ngcontent-%COMP%]{position:absolute;top:24px;left:0;right:0;height:6px;background-color:#27272a;border-radius:3px;overflow:visible;cursor:pointer}.selected-range[_ngcontent-%COMP%]{position:absolute;top:0;height:100%;background:linear-gradient(90deg,#3ecf8e,#2ea06d);border-radius:3px;transition:all .1s ease}.timeline-thumb[_ngcontent-%COMP%]{position:absolute;top:50%;transform:translate(-50%,-50%);z-index:3;pointer-events:auto;cursor:grab}.timeline-thumb[_ngcontent-%COMP%]:active{cursor:grabbing}.thumb-circle[_ngcontent-%COMP%]{width:18px;height:18px;background:linear-gradient(135deg,#3ecf8e,#2ea06d);border:3px solid #18181b;border-radius:50%;box-shadow:0 2px 8px #3ecf8e66,0 0 #3ecf8e66;transition:all .2s ease;pointer-events:none}.timeline-thumb[_ngcontent-%COMP%]:hover   .thumb-circle[_ngcontent-%COMP%]{transform:scale(1.15);box-shadow:0 4px 12px #3ecf8e99,0 0 0 4px #3ecf8e1a}.timeline-thumb[_ngcontent-%COMP%]:active   .thumb-circle[_ngcontent-%COMP%]{transform:scale(1.1)}"]})};var X=class m{constructor(e){this.supabase=e}async getDashboardStats(e){let n=new Date,t=n.getFullYear(),i=e?.startDate||`${t}-01-01`,a=e?.endDate||n.toISOString().slice(0,10);try{let s=this.supabase.client.from("incomes").select("amount").gte("date",i).lte("date",a);e?.paymentTypeIds?.length&&(s=s.in("paymentType_id",e.paymentTypeIds)),e?.incomeCategoryIds?.length&&(s=s.in("category_id",e.incomeCategoryIds));let{data:c}=await s,u=this.supabase.client.from("expenses").select("amount").gte("date",i).lte("date",a);e?.paymentTypeIds?.length&&(u=u.in("paymentType_id",e.paymentTypeIds)),e?.expenseCategoryIds?.length&&(u=u.in("category_id",e.expenseCategoryIds));let{data:p}=await u,h=c?.reduce((f,x)=>f+(x.amount||0),0)||0,v=p?.reduce((f,x)=>f+(x.amount||0),0)||0,b="";if(i&&a){let f=new Date(i),x=new Date(a),_=f.toLocaleDateString("en-US",{month:"short",year:"numeric"}),I=x.toLocaleDateString("en-US",{month:"short",year:"numeric"});b=`${_} - ${I}`}else b=`Year ${t}`;let O=h>0?(h-v)/h*100:0;return{totalIncomes:h,totalExpenses:v,balance:h-v,savingsPercentage:O,period:b}}catch(s){return console.error("Error fetching dashboard stats:",s),{totalIncomes:0,totalExpenses:0,balance:0,savingsPercentage:0,period:""}}}async getIncomesVsExpenses(e){let n=new Date,t=e?.startDate,i=e?.endDate||n.toISOString().slice(0,10);if(!t||!i)return[];try{let a=this.supabase.client.from("incomes").select("date, amount").gte("date",t).lt("date",i).order("date",{ascending:!0});e?.paymentTypeIds?.length&&(a=a.in("paymentType_id",e.paymentTypeIds)),e?.incomeCategoryIds?.length&&(a=a.in("category_id",e.incomeCategoryIds));let s=this.supabase.client.from("expenses").select("date, amount").gte("date",t).lt("date",i).order("date",{ascending:!0});e?.paymentTypeIds?.length&&(s=s.in("paymentType_id",e.paymentTypeIds)),e?.expenseCategoryIds?.length&&(s=s.in("category_id",e.expenseCategoryIds));let[c,u]=await Promise.all([a,s]),p={},h=new Date(t),v=new Date(i),b=new Date(h.getFullYear(),h.getMonth(),1),O=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];for(;b<=v;){let f=`${O[b.getMonth()]} ${String(b.getFullYear()).slice(2)}`;p[f]||(p[f]={month:f,incomes:0,expenses:0}),b.setMonth(b.getMonth()+1)}return c.data?.forEach(f=>{let x=new Date(f.date),_=`${O[x.getMonth()]} ${String(x.getFullYear()).slice(2)}`;p[_]&&(p[_].incomes+=f.amount||0)}),u.data?.forEach(f=>{let x=new Date(f.date),_=`${O[x.getMonth()]} ${String(x.getFullYear()).slice(2)}`;p[_]&&(p[_].expenses+=f.amount||0)}),Object.keys(p).sort((f,x)=>{let _=this.parseMonthKey(f),I=this.parseMonthKey(x);return _.getTime()-I.getTime()}).map(f=>p[f])}catch(a){return console.error("Error fetching incomes vs expenses:",a),[]}}parseMonthKey(e){let[n,t]=e.split(" "),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(n),s=2e3+parseInt(t,10);return new Date(s,a,1)}async getExpensesByCategory(e){let n=new Date,t=e?.startDate,i=e?.endDate||n.toISOString().slice(0,10);if(!t||!i)return[];try{let a=this.supabase.client.from("expenses").select("amount, category_id, expense_categories(name, color)").gte("date",t).lt("date",i);e?.paymentTypeIds?.length&&(a=a.in("paymentType_id",e.paymentTypeIds)),e?.expenseCategoryIds?.length&&(a=a.in("category_id",e.expenseCategoryIds));let{data:s,error:c}=await a;if(c)throw c;let u={};return s?.forEach(p=>{let h=p.expense_categories;if(h){let v=h.name;u[v]||(u[v]={value:0,color:h.color||"#71717a"}),u[v].value+=p.amount||0}}),Object.entries(u).map(([p,h])=>({name:p,value:h.value,color:h.color}))}catch(a){return console.error("Error fetching expenses by category:",a),[]}}async getExpensesByAccount(e){let n=new Date,t=e?.startDate,i=e?.endDate||n.toISOString().slice(0,10);if(!t||!i)return[];try{let a=this.supabase.client.from("expenses").select("amount, paymentType_id, payment_types(name, color)").gte("date",t).lt("date",i);e?.paymentTypeIds?.length&&(a=a.in("paymentType_id",e.paymentTypeIds)),e?.expenseCategoryIds?.length&&(a=a.in("category_id",e.expenseCategoryIds));let{data:s,error:c}=await a;if(c)throw c;let u={};return s?.forEach(p=>{let h=p.payment_types;if(h){let v=h.name;u[v]||(u[v]={value:0,color:h.color||"#71717a"}),u[v].value+=p.amount||0}}),Object.entries(u).map(([p,h])=>({name:p,value:h.value,color:h.color}))}catch(a){return console.error("Error fetching expenses by account:",a),[]}}async getIncomesByAccount(e){let n=new Date,t=e?.startDate,i=e?.endDate||n.toISOString().slice(0,10);if(!t||!i)return[];try{let a=this.supabase.client.from("incomes").select("amount, paymentType_id, payment_types(name, color)").gte("date",t).lt("date",i);e?.paymentTypeIds?.length&&(a=a.in("paymentType_id",e.paymentTypeIds)),e?.incomeCategoryIds?.length&&(a=a.in("category_id",e.incomeCategoryIds));let{data:s,error:c}=await a;if(c)throw c;let u={};return s?.forEach(p=>{let h=p.payment_types;if(h){let v=h.name;u[v]||(u[v]={value:0,color:h.color||"#71717a"}),u[v].value+=p.amount||0}}),Object.entries(u).map(([p,h])=>({name:p,value:h.value,color:h.color}))}catch(a){return console.error("Error fetching incomes by account:",a),[]}}async getExpensesByCategoryPerMonth(e){let n=new Date,t=e?.startDate,i=e?.endDate||n.toISOString().slice(0,10);if(!t||!i)return{categories:[],series:[],months:[]};try{let a=this.supabase.client.from("expenses").select("amount, date, category_id, expense_categories(name, color)").gte("date",t).lt("date",i);e?.paymentTypeIds?.length&&(a=a.in("paymentType_id",e.paymentTypeIds)),e?.expenseCategoryIds?.length&&(a=a.in("category_id",e.expenseCategoryIds));let{data:s,error:c}=await a;if(c)throw c;let u=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p={},h=new Date(t),v=new Date(i),b=new Date(h.getFullYear(),h.getMonth(),1),O=0;for(;b<=v;){let S=`${u[b.getMonth()]} ${String(b.getFullYear()).slice(2)}`;p[S]=O++,b.setMonth(b.getMonth()+1)}let f=Object.keys(p).sort((S,P)=>{let g=this.parseMonthKey(S),k=this.parseMonthKey(P);return g.getTime()-k.getTime()}),x={};s?.forEach(S=>{let P=S.expense_categories;if(P){let g=P.name,k=new Date(S.date),T=`${u[k.getMonth()]} ${String(k.getFullYear()).slice(2)}`,L=p[T];L!==void 0&&(x[g]||(x[g]={values:new Array(f.length).fill(0),color:P.color||"#71717a"}),x[g].values[L]+=S.amount||0)}});let _=Object.keys(x),I=_.map(S=>({name:S,data:x[S].values,color:x[S].color}));return{categories:_,series:I,months:f}}catch(a){return console.error("Error fetching expenses by category per month:",a),{categories:[],series:[],months:[]}}}async getFirstTransactionDate(){try{let[e,n]=await Promise.all([this.supabase.client.from("expenses").select("date").order("date",{ascending:!0}).limit(1).maybeSingle(),this.supabase.client.from("incomes").select("date").order("date",{ascending:!0}).limit(1).maybeSingle()]),t=e.data?.date,i=n.data?.date;return!t&&!i?null:t?i?t<i?t:i:t:i}catch(e){return console.error("Error getting first transaction date:",e),null}}async getTopExpenses(e){try{let n=new Date,t=e?.startDate,i=e?.endDate||n.toISOString().slice(0,10);if(!t||!i)return[];let a=this.supabase.client.from("expenses").select("id, name, amount, date, category_id, expense_categories(name, color)").gte("date",t).lt("date",i).order("amount",{ascending:!1}).limit(5);e?.paymentTypeIds?.length&&(a=a.in("paymentType_id",e.paymentTypeIds)),e?.expenseCategoryIds?.length&&(a=a.in("category_id",e.expenseCategoryIds));let{data:s}=await a;return(s||[]).map(c=>$(N({},c),{type:"expense",category:c.expense_categories?.name,color:c.expense_categories?.color}))}catch(n){return console.error("Error fetching top expenses:",n),[]}}async getRecentTransactions(e){try{let n=this.supabase.client.from("incomes").select("id, name, amount, date, category_id, income_categories(name)").order("date",{ascending:!1}).limit(3),t=this.supabase.client.from("expenses").select("id, name, amount, date, category_id, expense_categories(name)").order("date",{ascending:!1}).limit(3);e?.startDate&&(n=n.gte("date",e.startDate),t=t.gte("date",e.startDate)),e?.endDate&&(n=n.lt("date",e.endDate),t=t.lt("date",e.endDate)),e?.paymentTypeIds?.length&&(n=n.in("paymentType_id",e.paymentTypeIds),t=t.in("paymentType_id",e.paymentTypeIds)),e?.incomeCategoryIds?.length&&(n=n.in("category_id",e.incomeCategoryIds)),e?.expenseCategoryIds?.length&&(t=t.in("category_id",e.expenseCategoryIds));let[i,a]=await Promise.all([n,t]),s=(i.data||[]).map(p=>$(N({},p),{type:"income",category:p.income_categories?.name})),c=(a.data||[]).map(p=>$(N({},p),{type:"expense",category:p.expense_categories?.name})),u=[...s,...c];return u.sort((p,h)=>new Date(h.date).getTime()-new Date(p.date).getTime()),u.slice(0,5)}catch(n){return console.error("Error fetching recent transactions:",n),[]}}async getSankeyFlowData(e){try{let{data:n,error:t}=await this.supabase.client.rpc("get_sankey_flow_data",{start_date:e?.startDate||"1900-01-01",end_date:e?.endDate||"2100-12-31",payment_type_ids:e?.paymentTypeIds?.length?e.paymentTypeIds:null,income_category_ids:e?.incomeCategoryIds?.length?e.incomeCategoryIds:null,expense_category_ids:e?.expenseCategoryIds?.length?e.expenseCategoryIds:null});if(t)return console.error("Error fetching Sankey flow data:",t),this.getEmptySankeyData();let i=n;if(!i||i.length===0)return this.getEmptySankeyData();let a=i.filter(g=>g.flow_type==="income_to_account"),s=i.filter(g=>g.flow_type==="account_to_expense"),c=new Map,u=new Map,p=new Map;a.forEach(g=>{c.set(g.source_name,g.source_color),u.set(g.target_name,g.target_color)}),s.forEach(g=>{u.set(g.source_name,g.source_color),p.set(g.target_name,g.target_color)});let h=Array.from(c.keys()),v=Array.from(u.keys()),b=Array.from(p.keys()),O=[...h,...v,...b],f=[...h.map(g=>c.get(g)||"#3ECF8E"),...v.map(g=>u.get(g)||"#3B82F6"),...b.map(g=>p.get(g)||"#EF4444")],x=new Map;h.forEach((g,k)=>x.set(`income::${g}`,k)),v.forEach((g,k)=>x.set(`account::${g}`,h.length+k)),b.forEach((g,k)=>x.set(`expense::${g}`,h.length+v.length+k));let _=[],I=[],S=[],P=[];return a.forEach(g=>{let k=x.get(`income::${g.source_name}`),T=x.get(`account::${g.target_name}`);if(k!==void 0&&T!==void 0){_.push(k),I.push(T),S.push(g.total_amount);let L=g.source_color||"#3ECF8E";P.push(this.hexToRgba(L,.4))}}),s.forEach(g=>{let k=x.get(`account::${g.source_name}`),T=x.get(`expense::${g.target_name}`);if(k!==void 0&&T!==void 0){_.push(k),I.push(T),S.push(g.total_amount);let L=g.target_color||"#EF4444";P.push(this.hexToRgba(L,.4))}}),{node:{label:O,color:f,pad:15,thickness:20},link:{source:_,target:I,value:S,color:P},type:"sankey"}}catch(n){return console.error("Error processing Sankey data:",n),this.getEmptySankeyData()}}getEmptySankeyData(){return{node:{label:[],color:[],pad:15,thickness:20},link:{source:[],target:[],value:[],color:[]},type:"sankey"}}async getBalanceHistory(e){try{let n=this.supabase.client.from("payment_type_balance_history").select(`
          snapshot_date,
          balance,
          payment_type_id,
          payment_types!inner(name, color)
        `).order("snapshot_date",{ascending:!0});e?.startDate&&(n=n.gte("snapshot_date",e.startDate)),e?.endDate&&(n=n.lte("snapshot_date",e.endDate)),e?.paymentTypeIds?.length&&(n=n.in("payment_type_id",e.paymentTypeIds));let{data:t,error:i}=await n;return i?(console.error("Error fetching balance history:",i),[]):!t||t.length===0?[]:t.map(a=>({date:a.snapshot_date,balance:a.balance||0,paymentTypeId:a.payment_type_id,paymentTypeName:a.payment_types?.name||"Unknown",color:a.payment_types?.color||"#71717a"}))}catch(n){return console.error("Error in getBalanceHistory:",n),[]}}hexToRgba(e,n){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!t)return`rgba(128, 128, 128, ${n})`;let i=parseInt(t[1],16),a=parseInt(t[2],16),s=parseInt(t[3],16);return`rgba(${i}, ${a}, ${s}, ${n})`}static \u0275fac=function(n){return new(n||m)(re(xe))};static \u0275prov=ie({token:m,factory:m.\u0275fac,providedIn:"root"})};var He=()=>({width:"100%",height:"600px"}),Le=()=>({responsive:!0,displayModeBar:!1});function Re(m,e){m&1&&(r(0,"div",9)(1,"div",10),C(2,"div",11),r(3,"p",12),d(4,"Loading dashboard..."),o()()())}function ze(m,e){if(m&1&&(r(0,"div",71)(1,"div",72),d(2),C(3,"div",73),o()()),m&2){let n=e.$implicit,t=D(2);B("background",n.color||"#71717a")("width",t.stats.totalIncomes>0?n.value/t.stats.totalIncomes*100:0,"%"),l(2),J(" ",n.name,": ",t.formatCurrency(n.value)," ")}}function Ve(m,e){if(m&1&&(r(0,"div",71)(1,"div",72),d(2),C(3,"div",73),o()()),m&2){let n=e.$implicit,t=D(2);B("background",n.color||"#71717a")("width",t.stats.totalExpenses>0?n.value/t.stats.totalExpenses*100:0,"%"),l(2),J(" ",n.name,": ",t.formatCurrency(n.value)," ")}}function Ne(m,e){if(m&1){let n=te();r(0,"div",79),w("click",function(){R(n);let i=D().$implicit,a=D(2);return z(a.startEditBalance(i))}),r(1,"div",55),d(2),o(),F(),r(3,"svg",80),C(4,"path",81),o()()}if(m&2){let n=D().$implicit,t=D(2);l(),V("text-brand",(n.current_balance||0)>=0)("text-red-500",(n.current_balance||0)<0),l(),E(" ",t.formatCurrency(n.current_balance||0)," ")}}function $e(m,e){if(m&1){let n=te();r(0,"div",82)(1,"div",54),d(2,"Edit Current Balance"),o(),r(3,"input",83),w("input",function(i){R(n);let a=D(3);return z(a.editingBalanceValue=i.target.value)})("keydown.enter",function(){R(n);let i=D().$implicit,a=D(2);return z(a.saveBalance(i.id))})("keydown.escape",function(){R(n);let i=D(3);return z(i.cancelEditBalance())}),o(),r(4,"div",84)(5,"button",85),w("click",function(){R(n);let i=D(3);return z(i.cancelEditBalance())}),d(6," Cancel "),o(),r(7,"button",86),w("click",function(){R(n);let i=D().$implicit,a=D(2);return z(a.saveBalance(i.id))}),d(8),o()()()}if(m&2){let n=D(3);l(3),y("value",n.editingBalanceValue),l(2),y("disabled",n.isSavingBalance),l(2),y("disabled",n.isSavingBalance),l(),E(" ",n.isSavingBalance?"Saving...":"Save"," ")}}function je(m,e){if(m&1&&(r(0,"div",74)(1,"div",46)(2,"div",47)(3,"div",75),F(),r(4,"svg",49),C(5,"path",76),o()(),A(),r(6,"div",51)(7,"h4",52),d(8),o()()(),r(9,"div",53)(10,"div",54),d(11,"Current Balance"),o(),M(12,Ne,5,5,"div",77)(13,$e,9,4,"div",78),o(),r(14,"div",56),d(15),o()()()),m&2){let n=e.$implicit,t=D(2);l(3),B("background",n.color||"#71717a"),l(5),H(n.name),l(4),y("ngIf",t.editingBalanceId!==n.id),l(),y("ngIf",t.editingBalanceId===n.id),l(2),E(" Updated ",t.formatRelativeTime(n.last_balance_update)," ")}}function Ue(m,e){if(m&1&&(r(0,"div"),C(1,"apx-chart",87),o()),m&2){let n=D(2);l(),y("series",n.balanceHistoryChartOptions.series)("chart",n.balanceHistoryChartOptions.chart)("dataLabels",n.balanceHistoryChartOptions.dataLabels)("stroke",n.balanceHistoryChartOptions.stroke)("xaxis",n.balanceHistoryChartOptions.xaxis)("yaxis",n.balanceHistoryChartOptions.yaxis)("grid",n.balanceHistoryChartOptions.grid)("legend",n.balanceHistoryChartOptions.legend)("tooltip",n.balanceHistoryChartOptions.tooltip)("theme",n.balanceHistoryChartOptions.theme)("markers",n.balanceHistoryChartOptions.markers)}}function We(m,e){m&1&&(r(0,"div",88)(1,"div",10),F(),r(2,"svg",89),C(3,"path",90),o(),A(),r(4,"p",91),d(5,"No historical balance data available"),o(),r(6,"p",92),d(7,"Weekly snapshots will appear here after they are collected"),o()()())}function Ye(m,e){if(m&1&&C(0,"span",105),m&2){let n=D().$implicit;B("background",n.color)}}function Ge(m,e){if(m&1&&(r(0,"tr",100)(1,"td",101),d(2),o(),r(3,"td",102),M(4,Ye,1,2,"span",103),d(5),o(),r(6,"td",102),d(7),o(),r(8,"td",104),d(9),o()()),m&2){let n=e.$implicit,t=D(3);l(2),E(" ",n.name," "),l(2),y("ngIf",n.color),l(),E(" ",n.category||"-"," "),l(2),E(" ",t.formatDate(n.date)," "),l(2),E(" -",t.formatCurrency(n.amount)," ")}}function Je(m,e){if(m&1&&(r(0,"div",57)(1,"div",58)(2,"h4",59),d(3,"Top 5 Highest Expenses"),o()(),r(4,"div",93)(5,"table",94)(6,"thead",95)(7,"tr")(8,"th",96),d(9," Description "),o(),r(10,"th",96),d(11," Category "),o(),r(12,"th",96),d(13," Date "),o(),r(14,"th",97),d(15," Amount "),o()()(),r(16,"tbody",98),M(17,Ge,10,5,"tr",99),o()()()()),m&2){let n=D(2);l(17),y("ngForOf",n.topExpenses)}}function Ke(m,e){if(m&1&&C(0,"plotly-plot",106),m&2){let n=D(2);de(ne(5,He)),y("data",n.sankeyChartData)("layout",n.sankeyChartLayout)("config",ne(6,Le))}}function Qe(m,e){m&1&&(r(0,"div",88)(1,"p"),d(2,"No data available for the selected period and filters"),o()())}function qe(m,e){if(m&1&&(r(0,"div")(1,"div",13)(2,"div",14)(3,"div",15)(4,"div",16)(5,"div",17),F(),r(6,"svg",18),C(7,"path",19),o()(),A(),r(8,"div",20)(9,"dl")(10,"dt",21),d(11,"Total Incomes"),o(),r(12,"dd")(13,"div",22),d(14),o()()()()(),r(15,"div",5)(16,"div",23)(17,"span"),d(18,"Accounts"),o(),r(19,"span"),d(20),o()(),r(21,"div",24),M(22,ze,4,6,"div",25),o()()()(),r(23,"div",14)(24,"div",15)(25,"div",16)(26,"div",17),F(),r(27,"svg",26),C(28,"path",27),o()(),A(),r(29,"div",20)(30,"dl")(31,"dt",21),d(32,"Total Expenses"),o(),r(33,"dd")(34,"div",28),d(35),o()()()()(),r(36,"div",5)(37,"div",23)(38,"span"),d(39,"Accounts"),o(),r(40,"span"),d(41),o()(),r(42,"div",24),M(43,Ve,4,6,"div",25),o()()()(),r(44,"div",14)(45,"div",15)(46,"div",16)(47,"div",17),F(),r(48,"svg",29),C(49,"path",30),o()(),A(),r(50,"div",20)(51,"dl")(52,"dt",21),d(53,"Balance"),o(),r(54,"dd")(55,"div",31),d(56),o()()()()(),r(57,"div",32)(58,"div",33)(59,"div",34),d(60,"Savings Rate"),o(),r(61,"div",35),d(62),o()(),r(63,"div",36),C(64,"div",37),o()()()()(),r(65,"div",38)(66,"h3",39)(67,"span"),d(68,"Account Balances"),o(),r(69,"div",40)(70,"div")(71,"span",41),d(72,"Total Accounts:"),o(),r(73,"span",42),d(74),o()(),r(75,"div")(76,"span",41),d(77,"Total Investments:"),o(),r(78,"span",42),d(79),o()(),r(80,"div",43)(81,"span",41),d(82,"Total:"),o(),r(83,"span",42),d(84),o()()()(),r(85,"div",44),M(86,je,16,6,"div",45),r(87,"div",14)(88,"div",46)(89,"div",47)(90,"div",48),F(),r(91,"svg",49),C(92,"path",50),o()(),A(),r(93,"div",51)(94,"h4",52),d(95,"Total Portfolio Value"),o()()(),r(96,"div",53)(97,"div",54),d(98,"Current Value"),o(),r(99,"div",33)(100,"div",55),d(101),o()()(),r(102,"div",56),d(103," From Investments "),o()()()()(),r(104,"div",57)(105,"div",58)(106,"h4",59),d(107,"Balance History"),o(),r(108,"p",60),d(109,"Weekly balance snapshots over time"),o()(),r(110,"div",15),M(111,Ue,2,11,"div",61)(112,We,8,0,"ng-template",null,0,pe),o()(),M(114,Je,18,1,"div",62),r(115,"div",57)(116,"div",58)(117,"h4",59),d(118,"Incomes vs Expenses"),o()(),r(119,"div",15),C(120,"apx-chart",63),o()(),r(121,"div",57)(122,"div",58)(123,"h4",59),d(124,"Expenses by category"),o()(),r(125,"div",64),C(126,"apx-chart",65),o()(),r(127,"div",57)(128,"div",58)(129,"h4",59),d(130,"Money Flow"),o(),r(131,"p",66),d(132,"Income Categories \u2192 Accounts \u2192 Expense Categories"),o()(),r(133,"div",15),M(134,Ke,1,7,"plotly-plot",67)(135,Qe,3,0,"div",68),o()(),r(136,"div",69)(137,"div",14)(138,"div",58)(139,"h4",52),d(140,"Expenses by category"),o()(),r(141,"div",15),C(142,"apx-chart",70),o()(),r(143,"div",14)(144,"div",58)(145,"h4",52),d(146,"Expenses by account"),o()(),r(147,"div",15),C(148,"apx-chart",70),o()(),r(149,"div",14)(150,"div",58)(151,"h4",52),d(152,"Incomes by account"),o()(),r(153,"div",15),C(154,"apx-chart",70),o()()()()),m&2){let n=ce(113),t=D();l(14),E(" ",t.formatCurrency(t.stats.totalIncomes)," "),l(6),E("",t.incomesPaymentTypes.length," accounts"),l(2),y("ngForOf",t.incomesPaymentTypes),l(13),E(" ",t.formatCurrency(t.stats.totalExpenses)," "),l(6),E("",t.expensesPaymentTypes.length," accounts"),l(2),y("ngForOf",t.expensesPaymentTypes),l(5),V("text-brand",t.stats.balance>=0)("text-red-500",t.stats.balance<0),l(7),V("text-brand",t.stats.balance>=0)("text-red-500",t.stats.balance<0),l(),E(" ",t.formatCurrency(t.stats.balance)," "),l(5),V("text-brand",t.stats.savingsPercentage>=0)("text-red-500",t.stats.savingsPercentage<0),l(),J(" ",t.stats.savingsPercentage>=0?"+":"","",t.stats.savingsPercentage.toFixed(1),"% "),l(2),B("width",t.Math.max(0,t.Math.min(100,t.stats.savingsPercentage)),"%"),V("bg-brand",t.stats.savingsPercentage>=0)("bg-red-500",t.stats.savingsPercentage<0),l(10),H(t.formatCurrency(t.totalPaymentTypesBalance)),l(5),H(t.formatCurrency(t.totalPortfolioValue)),l(5),H(t.formatCurrency(t.totalAccountsBalance)),l(2),y("ngForOf",t.paymentTypesWithBalance),l(14),V("text-brand",t.totalPortfolioValue>=0)("text-red-500",t.totalPortfolioValue<0),l(),E(" ",t.formatCurrency(t.totalPortfolioValue)," "),l(10),y("ngIf",(t.balanceHistoryChartOptions==null||t.balanceHistoryChartOptions.series==null?null:t.balanceHistoryChartOptions.series.length)>0)("ngIfElse",n),l(3),y("ngIf",t.topExpenses.length>0),l(6),y("series",t.lineChartOptions.series)("chart",t.lineChartOptions.chart)("dataLabels",t.lineChartOptions.dataLabels)("stroke",t.lineChartOptions.stroke)("fill",t.lineChartOptions.fill)("xaxis",t.lineChartOptions.xaxis)("yaxis",t.lineChartOptions.yaxis)("grid",t.lineChartOptions.grid)("legend",t.lineChartOptions.legend)("tooltip",t.lineChartOptions.tooltip)("theme",t.lineChartOptions.theme),l(6),y("series",t.stackedBarChartOptions.series)("chart",t.stackedBarChartOptions.chart)("plotOptions",t.stackedBarChartOptions.plotOptions)("dataLabels",t.stackedBarChartOptions.dataLabels)("xaxis",t.stackedBarChartOptions.xaxis)("yaxis",t.stackedBarChartOptions.yaxis)("grid",t.stackedBarChartOptions.grid)("legend",t.stackedBarChartOptions.legend)("fill",t.stackedBarChartOptions.fill)("tooltip",t.stackedBarChartOptions.tooltip)("theme",t.stackedBarChartOptions.theme),l(8),y("ngIf",t.sankeyChartData&&t.sankeyChartLayout),l(),y("ngIf",!t.sankeyChartData||(t.sankeyChartData[0]==null||t.sankeyChartData[0].node==null||t.sankeyChartData[0].node.label==null?null:t.sankeyChartData[0].node.label.length)===0),l(7),y("series",t.expensesCategoryChartOptions.series)("chart",t.expensesCategoryChartOptions.chart)("labels",t.expensesCategoryChartOptions.labels)("colors",t.expensesCategoryChartOptions.colors)("dataLabels",t.expensesCategoryChartOptions.dataLabels)("plotOptions",t.expensesCategoryChartOptions.plotOptions)("legend",t.expensesCategoryChartOptions.legend)("tooltip",t.expensesCategoryChartOptions.tooltip)("theme",t.expensesCategoryChartOptions.theme)("states",t.expensesCategoryChartOptions.states)("stroke",t.expensesCategoryChartOptions.stroke),l(6),y("series",t.expensesAccountChartOptions.series)("chart",t.expensesAccountChartOptions.chart)("labels",t.expensesAccountChartOptions.labels)("colors",t.expensesAccountChartOptions.colors)("dataLabels",t.expensesAccountChartOptions.dataLabels)("plotOptions",t.expensesAccountChartOptions.plotOptions)("legend",t.expensesAccountChartOptions.legend)("tooltip",t.expensesAccountChartOptions.tooltip)("theme",t.expensesAccountChartOptions.theme)("states",t.expensesAccountChartOptions.states)("stroke",t.expensesCategoryChartOptions.stroke),l(6),y("series",t.incomesAccountChartOptions.series)("chart",t.incomesAccountChartOptions.chart)("labels",t.incomesAccountChartOptions.labels)("colors",t.incomesAccountChartOptions.colors)("dataLabels",t.incomesAccountChartOptions.dataLabels)("plotOptions",t.incomesAccountChartOptions.plotOptions)("legend",t.incomesAccountChartOptions.legend)("tooltip",t.incomesAccountChartOptions.tooltip)("theme",t.incomesAccountChartOptions.theme)("states",t.incomesAccountChartOptions.states)("stroke",t.expensesCategoryChartOptions.stroke)}}var Oe=class m{constructor(e,n,t,i,a){this.dashboardService=e;this.financeService=n;this.investmentsService=t;this.ngZone=i;this.cdr=a;this.initializeChartDefaults()}isLoading=!0;stats={totalIncomes:0,totalExpenses:0,balance:0,savingsPercentage:0,period:""};topExpenses=[];incomesPaymentTypes=[];expensesPaymentTypes=[];paymentTypesWithBalance=[];editingBalanceId=null;editingBalanceValue=0;isSavingBalance=!1;totalPortfolioValue=0;lineChartOptions;stackedBarChartOptions;expensesCategoryChartOptions;expensesAccountChartOptions;incomesAccountChartOptions;balanceHistoryChartOptions;sankeyChartData;sankeyChartLayout;selectedPeriod="current-month";selectedPaymentTypes=[];selectedExpenseCategories=[];selectedIncomeCategories=[];paymentTypes=[];expenseCategories=[];incomeCategories=[];periodOptions=[{value:"current-month",label:"Current Month"},{value:"last-30-days",label:"Last 30 days"},{value:"last-6-months",label:"Last 6 months"},{value:"last-12-months",label:"Last 12 months"},{value:"all",label:"All"},{value:"custom",label:"Custom"}];timelineMinDate="2022-01-01";timelineMaxDate=new Date().toISOString().split("T")[0];customDateRange=null;Math=Math;instanceId=Math.random().toString(16).slice(2,8);timelineDebounceTimer=null;TIMELINE_DEBOUNCE_MS=500;pageHeaderService=ee(we);themeService=ee(De);chartThemeMode=K(()=>this.themeService.isDarkMode()?"dark":"light");chartLegendColor=K(()=>this.themeService.isDarkMode()?"#e4e4e7":"#3f3f46");chartAxisColor=K(()=>this.themeService.isDarkMode()?"#a1a1aa":"#71717a");async ngOnInit(){this.pageHeaderService.setHeader("Dashboard"),await this.loadFilterOptions(),await this.loadPaymentTypesBalances(),await this.loadPortfolioValue(),await this.updateTimelineFromPeriod(),await this.loadDashboardData()}async loadFilterOptions(){try{let[e,n,t]=await Promise.all([this.financeService.getPaymentTypes(),this.financeService.getCategories(),this.financeService.getIncomeCategories()]);this.paymentTypes=e||[],this.expenseCategories=n||[],this.incomeCategories=t||[]}catch(e){console.error("Error loading filter options",e)}}async calculateDateRange(){let e=new Date,n=e.toISOString().slice(0,10),i=new Date(e.getFullYear(),e.getMonth()+1,1).toISOString().slice(0,10);switch(this.selectedPeriod){case"current-month":{let a=e.getFullYear(),s=e.getMonth()+1,c=new Date(a,e.getMonth()+1,0).getDate();return{startDate:`${a}-${String(s).padStart(2,"0")}-01`,endDate:`${a}-${String(s).padStart(2,"0")}-${String(c).padStart(2,"0")}`}}case"last-30-days":{let a=new Date(e);return a.setDate(a.getDate()-30),{startDate:a.toISOString().slice(0,10),endDate:n}}case"last-6-months":return{startDate:new Date(e.getFullYear(),e.getMonth()-5,1).toISOString().slice(0,10),endDate:i};case"last-12-months":return{startDate:new Date(e.getFullYear(),e.getMonth()-11,1).toISOString().slice(0,10),endDate:i};case"custom":{if(this.customDateRange)return{startDate:this.customDateRange.startDate,endDate:this.customDateRange.endDate};let a=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0);return{startDate:a.toISOString().slice(0,10),endDate:s.toISOString().slice(0,10)}}case"all":default:return{startDate:await this.getFirstTransactionDate()||void 0,endDate:i}}}async getFirstTransactionDate(){return await this.dashboardService.getFirstTransactionDate()}async buildFilters(){let e,n;if(this.customDateRange)e=this.customDateRange.startDate,n=this.customDateRange.endDate;else{let t=await this.calculateDateRange();e=t.startDate,n=t.endDate}return{startDate:e,endDate:n,paymentTypeIds:this.selectedPaymentTypes,expenseCategoryIds:this.selectedExpenseCategories,incomeCategoryIds:this.selectedIncomeCategories}}async onPeriodChange(e){this.selectedPeriod=e,this.selectedPeriod!=="custom"&&(this.customDateRange=null,await this.updateTimelineFromPeriod()),await this.loadDashboardData()}async onPaymentTypesChange(e){this.selectedPaymentTypes=e.map(n=>Number(n)),await this.loadDashboardData()}async onExpenseCategoriesChange(e){this.selectedExpenseCategories=e.map(n=>Number(n)),await this.loadDashboardData()}async onIncomeCategoriesChange(e){this.selectedIncomeCategories=e.map(n=>Number(n)),await this.loadDashboardData()}initializeChartDefaults(){this.lineChartOptions=this.createLineChartOptions([],[]),this.stackedBarChartOptions=this.createStackedBarOptions([],[]),this.expensesCategoryChartOptions=this.createPieChartOptions([],"Expenses by category"),this.expensesAccountChartOptions=this.createPieChartOptions([],"Expenses by account"),this.incomesAccountChartOptions=this.createPieChartOptions([],"Incomes by account"),this.balanceHistoryChartOptions=this.createBalanceHistoryChartOptions([])}async loadDashboardData(){this.isLoading=!0,console.info("[HomeComponent] loadDashboardData: start");try{let e=await this.buildFilters(),n=await Promise.allSettled([this.dashboardService.getDashboardStats(e),this.dashboardService.getIncomesVsExpenses(e),this.dashboardService.getExpensesByCategory(e),this.dashboardService.getExpensesByCategoryPerMonth(e),this.dashboardService.getExpensesByAccount(e),this.dashboardService.getIncomesByAccount(e),this.dashboardService.getTopExpenses(e),this.dashboardService.getSankeyFlowData(e),this.dashboardService.getBalanceHistory(e)]),[t,i,a,s,c,u,p,h,v]=n,b=(T,L)=>T.status==="fulfilled"?T.value:(console.warn("[HomeComponent] dashboard load item failed",T.reason),L),O=b(t,{totalIncomes:0,totalExpenses:0,balance:0,savingsPercentage:0,period:""}),f=b(i,[]),x=b(a,[]),_=b(s,{categories:[],series:[],months:[]}),I=b(c,[]),S=b(u,[]),P=b(p,[]),g=b(h,{node:{label:[],color:[],pad:15,thickness:20},link:{source:[],target:[],value:[],color:[]},type:"sankey"}),k=b(v,[]);this.ngZone.run(()=>{this.stats=O,this.topExpenses=P,this.expensesPaymentTypes=I,this.incomesPaymentTypes=S,this.lineChartOptions=this.createLineChartOptions(f,f.map(T=>T.month)),this.stackedBarChartOptions=this.createStackedBarOptions(_.series,_.months),this.expensesCategoryChartOptions=this.createPieChartOptions(x,"Expenses by category"),this.expensesAccountChartOptions=this.createPieChartOptions(I,"Expenses by account"),this.incomesAccountChartOptions=this.createPieChartOptions(S,"Incomes by account"),this.balanceHistoryChartOptions=this.createBalanceHistoryChartOptions(k),console.log("[HomeComponent] Sankey data received:",g),this.createSankeyChart(g),console.log("[HomeComponent] Sankey chart created:",{hasData:!!this.sankeyChartData,hasLayout:!!this.sankeyChartLayout,nodeCount:this.sankeyChartData?.[0]?.node?.label?.length||0}),this.cdr.detectChanges()})}catch(e){console.error("Error loading dashboard data:",e)}finally{this.ngZone.run(()=>{this.isLoading=!1,this.cdr.detectChanges()}),console.info("[HomeComponent] loadDashboardData: end")}}createLineChartOptions(e,n){let t=e.map(a=>a.incomes||0),i=e.map(a=>a.expenses||0);return{series:[{name:"Incomes",data:t,color:"#3ECF8E"},{name:"Expenses",data:i,color:"#ef4444"}],chart:{type:"area",height:350,background:"transparent",toolbar:{show:!1},zoom:{enabled:!1}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:2},fill:{type:"gradient",gradient:{shadeIntensity:1,opacityFrom:.4,opacityTo:.1,stops:[0,90,100]}},xaxis:{categories:n,labels:{style:{colors:this.chartAxisColor(),fontSize:"12px"}},axisBorder:{show:!1},axisTicks:{show:!1}},yaxis:{labels:{style:{colors:this.chartAxisColor(),fontSize:"12px"},formatter:a=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(a)}},grid:{borderColor:"#2a2a2a",strokeDashArray:4,xaxis:{lines:{show:!1}}},legend:{position:"top",horizontalAlign:"right",labels:{colors:this.chartLegendColor()},markers:{size:6,strokeWidth:0}},tooltip:{theme:"dark",y:{formatter:a=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR"}).format(a)}},theme:{mode:"dark"}}}createStackedBarOptions(e,n){return{series:e.map(i=>$(N({},i),{data:i.data.map(a=>a),color:i.color})),chart:{type:"bar",height:400,stacked:!0,background:"transparent",toolbar:{show:!1},foreColor:this.chartAxisColor()},plotOptions:{bar:{horizontal:!1,columnWidth:"60%",borderRadius:4,dataLabels:{position:"top"}}},fill:{opacity:.5},dataLabels:{enabled:!1},xaxis:{categories:n,labels:{style:{colors:this.chartAxisColor(),fontSize:"12px"}},axisBorder:{show:!1},axisTicks:{show:!1}},yaxis:{labels:{style:{colors:this.chartAxisColor(),fontSize:"12px"},formatter:i=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(i)}},grid:{borderColor:"#2a2a2a",strokeDashArray:4,xaxis:{lines:{show:!1}}},legend:{position:"top",horizontalAlign:"left",labels:{colors:this.chartLegendColor()},markers:{width:10,height:10,radius:5,shape:"circle",strokeWidth:0}},tooltip:{theme:"dark",y:{formatter:i=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR"}).format(i)}},theme:{mode:"dark"}}}hexToRgba(e,n){let t=e.replace("#",""),i=parseInt(t.substring(0,2),16),a=parseInt(t.substring(2,4),16),s=parseInt(t.substring(4,6),16);return`rgba(${i}, ${a}, ${s}, ${n})`}createPieChartOptions(e,n){let t=e.map(c=>c.value),i=e.map(c=>c.name),a=e.map(c=>c.color),s=a.length>0?a.map(c=>this.hexToRgba(c,.5)):[this.hexToRgba("#71717a",.5)];return{series:t.length>0?t:[1],chart:{type:"donut",height:320,background:"transparent"},labels:i.length>0?i:["No data"],colors:s,dataLabels:{enabled:!1},plotOptions:{pie:{donut:{size:"70%",labels:{show:!0,total:{show:!0,label:"Total",fontSize:"14px",color:this.chartAxisColor(),formatter:c=>{let u=c.globals.seriesTotals.reduce((p,h)=>p+h,0);return new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(u)}},value:{show:!0,fontSize:"20px",color:this.chartLegendColor(),fontWeight:600}}}}},stroke:{show:!1,width:0,colors:["transparent"]},legend:{position:"bottom",labels:{colors:this.chartLegendColor()},markers:{size:6,strokeWidth:0}},tooltip:{theme:"dark",y:{formatter:c=>new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR"}).format(c)}},theme:{mode:"dark"},states:{hover:{filter:{type:"lighten",value:.1}}}}}formatCurrency(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR"}).format(e)}createBalanceHistoryChartOptions(e){if(!e||e.length===0)return{series:[],chart:{type:"line",height:400,background:"transparent",toolbar:{show:!1}},xaxis:{categories:[]},yaxis:{labels:{style:{colors:this.chartAxisColor()}}},theme:{mode:"dark"}};let n=e.reduce((s,c)=>(s[c.paymentTypeId]||(s[c.paymentTypeId]={name:c.paymentTypeName,color:c.color,data:[]}),s[c.paymentTypeId].data.push({date:c.date,balance:c.balance}),s),{}),t=[...new Set(e.map(s=>s.date))].sort(),i=Object.values(n).map(s=>{let c=new Map(s.data.map(p=>[p.date,p.balance])),u=t.map(p=>c.get(p)??null);return{name:s.name,data:u,color:s.color}}),a=t.map(s=>new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"2-digit"}));return{series:i,chart:{type:"line",height:400,background:"transparent",toolbar:{show:!0,tools:{download:!0,selection:!1,zoom:!1,zoomin:!1,zoomout:!1,pan:!1,reset:!1}},zoom:{enabled:!1}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},xaxis:{categories:a,labels:{style:{colors:this.chartAxisColor(),fontSize:"12px"},rotate:-45,rotateAlways:!1},axisBorder:{show:!1},axisTicks:{show:!1}},yaxis:{labels:{style:{colors:this.chartAxisColor(),fontSize:"12px"},formatter:s=>s==null?"":new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}},grid:{borderColor:"#2a2a2a",strokeDashArray:4,xaxis:{lines:{show:!1}}},legend:{position:"top",horizontalAlign:"left",labels:{colors:this.chartLegendColor()},markers:{size:6,strokeWidth:0}},tooltip:{theme:"dark",x:{show:!0},y:{formatter:s=>s==null?"No data":new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR"}).format(s)}},theme:{mode:"dark"},markers:{size:4,hover:{size:6}}}}get totalPaymentTypesBalance(){return this.paymentTypesWithBalance.reduce((e,n)=>e+(n.current_balance||0),0)}get totalAccountsBalance(){return this.totalPaymentTypesBalance+this.totalPortfolioValue}formatDate(e){return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}async loadPaymentTypesBalances(){try{this.paymentTypesWithBalance=await this.financeService.getPaymentTypesWithBalance()}catch(e){console.error("Error loading payment types balances:",e)}}async loadPortfolioValue(){try{let e=await this.investmentsService.getPortfolioSummary();this.totalPortfolioValue=e.totalValue}catch(e){console.error("Error loading portfolio value:",e),this.totalPortfolioValue=0}}startEditBalance(e){this.editingBalanceId=e.id,this.editingBalanceValue=e.current_balance||0}cancelEditBalance(){this.editingBalanceId=null,this.editingBalanceValue=0}async saveBalance(e){if(this.isSavingBalance){console.log("Save already in progress, ignoring...");return}this.isSavingBalance=!0;try{console.log("Saving balance - ID:",e,"Value:",this.editingBalanceValue,"Type:",typeof this.editingBalanceValue);let n=Number(this.editingBalanceValue);if(isNaN(n)){alert("Please enter a valid number"),this.isSavingBalance=!1;return}console.log("Converted value:",n);let t=this.paymentTypesWithBalance.find(i=>i.id===e);t&&(t.current_balance=n,t.last_balance_update=new Date().toISOString()),this.editingBalanceId=null,this.editingBalanceValue=0,await this.financeService.updateCurrentBalance(e,n),console.log("Balance saved successfully")}catch(n){console.error("Error updating balance:",n),alert("Error updating balance: "+n?.message||"Unknown error"),await this.loadPaymentTypesBalances()}finally{this.isSavingBalance=!1}}formatRelativeTime(e){if(!e)return"Never updated";let n=new Date(e),i=new Date().getTime()-n.getTime(),a=Math.floor(i/6e4),s=Math.floor(i/36e5),c=Math.floor(i/864e5);return a<1?"Just now":a<60?`${a} minute${a>1?"s":""} ago`:s<24?`${s} hour${s>1?"s":""} ago`:c<7?`${c} day${c>1?"s":""} ago`:this.formatDate(e)}createSankeyChart(e){this.sankeyChartData=[{type:"sankey",orientation:"h",node:{pad:e.node.pad,thickness:e.node.thickness,line:{color:"rgba(255, 255, 255, 0.1)",width:.5},label:e.node.label,color:e.node.color},link:{source:e.link.source,target:e.link.target,value:e.link.value,color:e.link.color}}],this.sankeyChartLayout={title:{font:{size:16,color:"#ffffff",family:"Inter, system-ui, sans-serif"}},font:{size:11,color:"#a1a1aa",family:"Inter, system-ui, sans-serif"},paper_bgcolor:"transparent",plot_bgcolor:"transparent",height:600,margin:{l:20,r:20,t:60,b:20}}}async onDateRangeChange(e){this.customDateRange=e,console.log("Custom date range selected:",e),e&&this.selectedPeriod!=="custom"&&(this.selectedPeriod="custom"),this.timelineDebounceTimer&&clearTimeout(this.timelineDebounceTimer),this.timelineDebounceTimer=setTimeout(async()=>{await this.loadDashboardData(),this.timelineDebounceTimer=null},this.TIMELINE_DEBOUNCE_MS)}async updateTimelineFromPeriod(){let{startDate:e,endDate:n}=await this.calculateDateRange();e&&n&&(this.customDateRange={startDate:e,endDate:n})}static \u0275fac=function(n){return new(n||m)(j(X),j(ke),j(Me),j(se),j(he))};static \u0275cmp=G({type:m,selectors:[["app-home"]],decls:15,vars:21,consts:[["noBalanceHistory",""],[1,"space-y-4","sm:space-y-6","p-3","sm:p-6"],[1,"bg-white","dark:bg-background-card","border","border-zinc-300","dark:border-sidebar-border","rounded-lg","p-4","mb-4","transition-colors","duration-200"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-4","gap-4"],[3,"ngModelChange","selectionChange","options","label","placeholder","ngModel"],[1,"mt-4","pt-4","border-t","border-zinc-300","dark:border-sidebar-border","transition-colors","duration-200"],[3,"ngModelChange","rangeChange","minDate","maxDate","ngModel"],["class","flex items-center justify-center py-12",4,"ngIf"],[4,"ngIf"],[1,"flex","items-center","justify-center","py-12"],[1,"text-center"],[1,"inline-block","animate-spin","rounded-full","h-8","w-8","border-b-2","border-brand"],[1,"mt-2","text-sm","text-zinc-500","dark:text-slate-400","transition-colors","duration-200"],[1,"grid","grid-cols-1","gap-5","sm:grid-cols-2","lg:grid-cols-3","mb-6"],[1,"overflow-hidden","rounded-lg","bg-white","dark:bg-background-card","shadow","border","border-zinc-300","dark:border-sidebar-border","transition-colors","duration-200"],[1,"p-5"],[1,"flex","items-center"],[1,"flex-shrink-0"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","text-brand"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M7 11l5-5m0 0l5 5m-5-5v12"],[1,"ml-5","w-0","flex-1"],[1,"truncate","text-sm","font-medium","text-zinc-500","dark:text-slate-400","transition-colors","duration-200"],[1,"text-lg","font-semibold","text-brand"],[1,"flex","items-center","justify-between","text-sm","text-zinc-500","dark:text-slate-400","mb-2","transition-colors","duration-200"],[1,"flex","items-center","space-x-1","relative"],["class","flex-1 h-2 rounded-full relative group",3,"background","width",4,"ngFor","ngForOf"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","text-red-500"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M17 13l-5 5m0 0l-5-5m5 5V6"],[1,"text-lg","font-semibold","text-red-500"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-lg","font-semibold"],[1,"mt-4","pt-4","border-t","border-sidebar-border"],[1,"flex","items-center","justify-between"],[1,"text-sm","text-zinc-500","dark:text-slate-400","transition-colors","duration-200"],[1,"text-sm","font-semibold"],[1,"mt-2","w-full","bg-slate-700","rounded-full","h-2"],[1,"h-2","rounded-full"],[1,"mb-6"],[1,"text-base","font-semibold","text-zinc-900","dark:text-white","mb-4","flex","flex-col","gap-3","sm:flex-row","sm:justify-between","sm:items-center","transition-colors","duration-200"],[1,"flex","flex-col","gap-2","sm:flex-row","sm:items-center","sm:gap-4","text-xs","sm:text-sm"],[1,"text-zinc-500","dark:text-slate-400","transition-colors","duration-200"],[1,"font-medium","text-green-500","ml-1","sm:ml-2"],[1,"sm:border-l","sm:border-slate-600","sm:pl-4"],[1,"grid","grid-cols-1","gap-4","sm:grid-cols-2","lg:grid-cols-3","xl:grid-cols-4"],["class","overflow-hidden rounded-lg bg-white dark:bg-background-card shadow border border-zinc-300 dark:border-sidebar-border hover:border-brand/50 transition-colors duration-200",4,"ngFor","ngForOf"],[1,"p-4"],[1,"flex","items-center","mb-3"],[1,"flex-shrink-0","w-10","h-10","rounded-full","flex","items-center","justify-center","bg-brand"],["fill","none","viewBox","0 0 24 24","stroke","currentColor","stroke-width","2",1,"w-5","h-5","text-white"],["stroke-linecap","round","stroke-linejoin","round","d","M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"],[1,"ml-3","flex-1"],[1,"text-sm","font-semibold","text-zinc-900","dark:text-white","transition-colors","duration-200"],[1,"mb-2"],[1,"text-xs","text-zinc-500","dark:text-slate-400","mb-1","transition-colors","duration-200"],[1,"text-xl","font-bold"],[1,"text-xs","text-slate-500"],[1,"mb-6","overflow-hidden","rounded-lg","bg-white","dark:bg-background-card","shadow","border","border-zinc-300","dark:border-sidebar-border","transition-colors","duration-200"],[1,"px-5","py-4","border-b","border-zinc-300","dark:border-sidebar-border","transition-colors","duration-200"],[1,"text-base","font-semibold","text-zinc-900","dark:text-white","transition-colors","duration-200"],[1,"mt-1","text-xs","text-zinc-500","dark:text-slate-400","transition-colors","duration-200"],[4,"ngIf","ngIfElse"],["class","mb-6 overflow-hidden rounded-lg bg-white dark:bg-background-card shadow border border-zinc-300 dark:border-sidebar-border transition-colors duration-200",4,"ngIf"],[3,"series","chart","dataLabels","stroke","fill","xaxis","yaxis","grid","legend","tooltip","theme"],[1,"p-5","stacked-bar-chart-container"],[3,"series","chart","plotOptions","dataLabels","xaxis","yaxis","grid","legend","fill","tooltip","theme"],[1,"mt-1","text-xs","text-slate-400"],[3,"data","layout","config","style",4,"ngIf"],["class","flex items-center justify-center h-96 text-slate-400",4,"ngIf"],[1,"grid","grid-cols-1","gap-5","lg:grid-cols-3"],[3,"series","chart","labels","colors","dataLabels","plotOptions","legend","tooltip","theme","states","stroke"],[1,"flex-1","h-2","rounded-full","relative","group"],[1,"absolute","bottom-full","left-1/2","transform","-translate-x-1/2","mb-2","px-2","py-1","bg-slate-800","text-white","text-xs","rounded","opacity-0","group-hover:opacity-100","transition-opacity","whitespace-nowrap","z-10"],[1,"absolute","top-full","left-1/2","transform","-translate-x-1/2","w-0","h-0","border-l-4","border-r-4","border-t-4","border-transparent","border-t-slate-800"],[1,"overflow-hidden","rounded-lg","bg-white","dark:bg-background-card","shadow","border","border-zinc-300","dark:border-sidebar-border","hover:border-brand/50","transition-colors","duration-200"],[1,"flex-shrink-0","w-10","h-10","rounded-full","flex","items-center","justify-center"],["stroke-linecap","round","stroke-linejoin","round","d","M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"],["class","flex items-center justify-between group cursor-pointer",3,"click",4,"ngIf"],["class","space-y-2",4,"ngIf"],[1,"flex","items-center","justify-between","group","cursor-pointer",3,"click"],["fill","none","viewBox","0 0 24 24","stroke","currentColor","stroke-width","2",1,"w-4","h-4","text-slate-500","opacity-0","group-hover:opacity-100","transition-opacity"],["stroke-linecap","round","stroke-linejoin","round","d","M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"],[1,"space-y-2"],["type","number","step","0.01","autofocus","",1,"w-full","px-3","py-2","bg-white","dark:bg-background","border","border-zinc-300","dark:border-sidebar-border","rounded-md","text-zinc-900","dark:text-white","focus:outline-none","focus:ring-2","focus:ring-brand","focus:border-transparent","transition-colors","duration-200",3,"input","keydown.enter","keydown.escape","value"],[1,"flex","items-center","justify-end","space-x-2"],[1,"px-3","py-1","text-xs","text-slate-400","hover:text-white","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"px-3","py-1","text-xs","bg-brand","text-white","rounded","hover:bg-brand/80","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[3,"series","chart","dataLabels","stroke","xaxis","yaxis","grid","legend","tooltip","theme","markers"],[1,"flex","items-center","justify-center","h-96","text-slate-400"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"w-16","h-16","mx-auto","mb-4","text-slate-600"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"],[1,"text-sm"],[1,"text-xs","mt-2"],[1,"overflow-x-auto"],[1,"min-w-full","divide-y","divide-zinc-300","dark:divide-sidebar-border","transition-colors","duration-200"],[1,""],["scope","col",1,"px-5","py-3","text-left","text-xs","font-medium","text-zinc-500","dark:text-zinc-300","uppercase","tracking-wider","transition-colors","duration-200"],["scope","col",1,"px-5","py-3","text-right","text-xs","font-medium","text-zinc-500","dark:text-zinc-300","uppercase","tracking-wider","transition-colors","duration-200"],[1,"divide-y","divide-zinc-300","dark:divide-sidebar-border","transition-colors","duration-200"],["class","hover:bg-zinc-100 dark:hover:bg-slate-900/30 transition-colors duration-200",4,"ngFor","ngForOf"],[1,"hover:bg-zinc-100","dark:hover:bg-slate-900/30","transition-colors","duration-200"],[1,"px-5","py-4","whitespace-nowrap","text-sm","font-medium","text-zinc-900","dark:text-white","transition-colors","duration-200"],[1,"px-5","py-4","whitespace-nowrap","text-sm","text-zinc-500","dark:text-zinc-300","transition-colors","duration-200"],["class","inline-block h-3 w-3 rounded-full mr-2",3,"background",4,"ngIf"],[1,"px-5","py-4","whitespace-nowrap","text-sm","text-right","font-semibold","text-red-500"],[1,"inline-block","h-3","w-3","rounded-full","mr-2"],[3,"data","layout","config"]],template:function(n,t){n&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"div")(4,"app-select",4),Y("ngModelChange",function(a){return W(t.selectedPeriod,a)||(t.selectedPeriod=a),a}),w("selectionChange",function(a){return t.onPeriodChange(a)}),o()(),r(5,"div")(6,"app-multiselect",4),Y("ngModelChange",function(a){return W(t.selectedPaymentTypes,a)||(t.selectedPaymentTypes=a),a}),w("selectionChange",function(a){return t.onPaymentTypesChange(a)}),o()(),r(7,"div")(8,"app-multiselect",4),Y("ngModelChange",function(a){return W(t.selectedExpenseCategories,a)||(t.selectedExpenseCategories=a),a}),w("selectionChange",function(a){return t.onExpenseCategoriesChange(a)}),o()(),r(9,"div")(10,"app-multiselect",4),Y("ngModelChange",function(a){return W(t.selectedIncomeCategories,a)||(t.selectedIncomeCategories=a),a}),w("selectionChange",function(a){return t.onIncomeCategoriesChange(a)}),o()()(),r(11,"div",5)(12,"app-date-range-timeline",6),Y("ngModelChange",function(a){return W(t.customDateRange,a)||(t.customDateRange=a),a}),w("rangeChange",function(a){return t.onDateRangeChange(a)}),o()()(),M(13,Re,5,0,"div",7)(14,qe,155,96,"div",8),o()),n&2&&(l(4),y("options",t.periodOptions)("label","Period")("placeholder","Select period..."),U("ngModel",t.selectedPeriod),l(2),y("options",t.paymentTypes)("label","Accounts")("placeholder","Select accounts..."),U("ngModel",t.selectedPaymentTypes),l(2),y("options",t.expenseCategories)("label","Expense categories")("placeholder","Select categories..."),U("ngModel",t.selectedExpenseCategories),l(2),y("options",t.incomeCategories)("label","Income categories")("placeholder","Select categories..."),U("ngModel",t.selectedIncomeCategories),l(2),y("minDate",t.timelineMinDate)("maxDate",t.timelineMaxDate),U("ngModel",t.customDateRange),l(),y("ngIf",t.isLoading),l(),y("ngIf",!t.isLoading))},dependencies:[q,Q,ge,Te,Ee,ye,ue,Se,_e,Ce,fe,ve,Z],styles:["[_nghost-%COMP%]{display:block}"]})};export{Oe as HomeComponent};
