<div class="max-w-7xl mx-auto p-4 space-y-6">
  <!-- Calendar Dialog -->
  <app-calendar-dialog
    *ngIf="showCalendarDialog()"
    (close)="closeCalendarDialog()"
  ></app-calendar-dialog>

  <!-- Header Actions Template -->
  <ng-template #headerActions>
    <div class="flex items-center gap-2">
      <button
        (click)="openCalendarDialog()"
        class="px-3 py-1.5 bg-zinc-800 text-zinc-300 rounded-md hover:bg-zinc-700 transition-colors text-sm font-medium flex items-center gap-1.5"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <span class="hidden sm:inline">Select date</span>
      </button>
      <button
        (click)="goToToday()"
        class="px-3 py-1.5 bg-zinc-800 text-zinc-300 rounded-md hover:bg-zinc-700 transition-colors text-sm"
      >
        Oggi
      </button>
      <button
        [routerLink]="['/planner/search']"
        class="px-3 py-1.5 bg-brand text-black rounded-md hover:bg-brand/90 transition-colors text-sm font-medium flex items-center gap-1.5"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35"></path>
        </svg>
        <span class="hidden sm:inline">Search journals</span>
      </button>
    </div>
  </ng-template>

  <!-- Loading State -->
  <div *ngIf="loading()" class="flex items-center justify-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand"></div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading() && dayEntry()" class="space-y-6">
    <!-- Date Navigation -->
    <div class="bg-background-card border border-zinc-800 rounded-lg p-4">
      <div class="flex items-center justify-between gap-4">
        <button
          *ngIf="hasPreviousEntry()"
          (click)="goToPreviousDay()"
          class="p-2 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-md transition-colors"
          title="Previous day with entries"
        >
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <div *ngIf="!hasPreviousEntry()" class="p-2 w-9 h-9"></div>

        <div class="flex-1 text-center">
          <h2 class="text-xl font-semibold text-white capitalize">{{ formattedDate() }}</h2>
        </div>

        <button
          *ngIf="hasNextEntry()"
          (click)="goToNextDay()"
          class="p-2 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-md transition-colors"
          title="Next day with entries"
        >
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </button>
        <div *ngIf="!hasNextEntry()" class="p-2 w-9 h-9"></div>
      </div>
    </div>

    <!-- Planner Section -->
    <div class="bg-background-card border border-zinc-800 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
        <svg class="h-5 w-5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        Planner
      </h3>

      <!-- Add Task -->
      <div class="mb-4">
        <div class="flex gap-2">
          <input
            type="text"
            [value]="newTaskText()"
            (input)="newTaskText.set($any($event.target).value)"
            (keydown.enter)="addTask()"
            placeholder="Add a task..."
            class="flex-1 bg-background border border-zinc-700 rounded-md px-4 py-2 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand"
          />
          <button
            (click)="addTask()"
            [disabled]="!newTaskText().trim()"
            class="px-4 py-2 bg-brand text-black rounded-md hover:bg-brand/90 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Add
          </button>
        </div>
      </div>

      <!-- Tasks List -->
      <div cdkDropList (cdkDropListDropped)="onTaskDrop($event)" class="space-y-2">
        <div
          *ngFor="let task of tasks()"
          cdkDrag
          class="flex items-center gap-3 p-3 bg-zinc-900 border border-zinc-800 rounded-md hover:border-zinc-700 transition-colors group"
        >
          <!-- Drag Handle -->
          <div cdkDragHandle class="cursor-move text-zinc-600 hover:text-zinc-400">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16" />
            </svg>
          </div>

          <!-- Checkbox -->
          <button
            (click)="toggleTaskStatus(task)"
            class="flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors"
            [class.border-brand]="task.status === 'done'"
            [class.bg-brand]="task.status === 'done'"
            [class.border-zinc-600]="task.status !== 'done'"
          >
            <svg
              *ngIf="task.status === 'done'"
              class="h-3 w-3 text-black"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="3"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
          </button>

          <!-- Task Text -->
          <div class="flex-1" *ngIf="editingTaskId() !== task.id">
            <span
              [class.line-through]="task.status === 'done'"
              [class.text-zinc-500]="task.status === 'done'"
              [class.text-white]="task.status !== 'done'"
              class="break-words"
            >
              {{ task.text }}
            </span>
            <span
              *ngIf="task.status === 'postponed'"
              class="ml-2 text-xs text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded"
            >
              Postponed
            </span>
          </div>

          <!-- Edit Mode -->
          <div class="flex-1 flex gap-2" *ngIf="editingTaskId() === task.id">
            <input
              type="text"
              [value]="editingTaskText()"
              (input)="editingTaskText.set($any($event.target).value)"
              (keydown.enter)="saveEditTask(task)"
              (keydown.escape)="cancelEditTask()"
              class="flex-1 bg-background border border-zinc-700 rounded px-2 py-1 text-sm text-white focus:outline-none focus:ring-2 focus:ring-brand"
              autofocus
            />
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button
              *ngIf="editingTaskId() !== task.id"
              (click)="startEditTask(task)"
              class="p-1 text-zinc-500 hover:text-white rounded transition-colors"
              title="Edit"
            >
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </button>
            <button
              *ngIf="editingTaskId() === task.id"
              (click)="saveEditTask(task)"
              class="p-1 text-green-500 hover:text-green-400 rounded transition-colors"
              title="Save"
            >
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              *ngIf="editingTaskId() === task.id"
              (click)="cancelEditTask()"
              class="p-1 text-zinc-500 hover:text-white rounded transition-colors"
              title="Cancel"
            >
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            <button
              *ngIf="editingTaskId() !== task.id && task.status === 'todo'"
              (click)="markAsPostponed(task)"
              class="p-1 text-zinc-500 hover:text-amber-500 rounded transition-colors"
              title="Postpone"
            >
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
            <button
              *ngIf="editingTaskId() !== task.id"
              (click)="deleteTask(task)"
              class="p-1 text-zinc-500 hover:text-red-500 rounded transition-colors"
              title="Delete"
            >
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="tasks().length === 0" class="text-center py-8 text-zinc-500">
          <svg class="h-12 w-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <p>No tasks for today</p>
        </div>
      </div>

      <!-- Task Stats -->
      <div *ngIf="tasks().length > 0" class="mt-4 pt-4 border-t border-zinc-800 flex items-center justify-between text-sm">
        <div class="flex gap-4">
          <span class="text-zinc-400">
            To do: <span class="text-white font-medium">{{ todoTasks().length }}</span>
          </span>
          <span class="text-zinc-400">
            Completed: <span class="text-green-500 font-medium">{{ doneTasks().length }}</span>
          </span>
          <span *ngIf="postponedTasks().length > 0" class="text-zinc-400">
            Postponed: <span class="text-amber-500 font-medium">{{ postponedTasks().length }}</span>
          </span>
        </div>
      </div>
    </div>

    <!-- Journal Section -->
    <div class="bg-background-card border border-zinc-800 rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
          <svg class="h-5 w-5 text-brand" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
          Journal
        </h3>
        <div class="flex items-center gap-3">
          <button
            [routerLink]="['/planner/journal', currentDate()]"
            class="px-3 py-1.5 bg-brand text-black rounded-md hover:bg-brand/90 transition-colors text-sm font-medium flex items-center gap-1.5"
            title="Open full-screen journal"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
            <span class="hidden sm:inline">Full-screen mode</span>
            <span class="sm:hidden">Expand</span>
          </button>
          <span *ngIf="savingJournal()" class="text-xs text-zinc-500">Saving...</span>
        </div>
      </div>

      <!-- Free Text Journal (Always visible) -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-zinc-300 mb-2">
          Free thoughts and notes
        </label>
        <textarea
          [value]="freeText()"
          (input)="freeText.set($any($event.target).value); onJournalChange()"
          rows="6"
          placeholder="Write your thoughts, ideas, reflections..."
          class="w-full bg-background border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand resize-none"
        ></textarea>
      </div>

      <!-- Mood Selector -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-zinc-300 mb-3">How are you feeling today?</h4>
        <div class="flex flex-wrap items-center gap-2">
          <button
            *ngFor="let mood of moods"
            (click)="selectMood(mood.value)"
            [class.bg-brand]="selectedMood() === mood.value"
            [class.text-black]="selectedMood() === mood.value"
            [class.bg-zinc-800]="selectedMood() !== mood.value"
            [class.text-zinc-300]="selectedMood() !== mood.value"
            class="px-4 py-2 rounded-md hover:opacity-80 transition-all text-sm flex items-center gap-2"
            [title]="mood.label"
          >
            <span class="text-lg">{{ mood.emoji }}</span>
            <span class="hidden sm:inline">{{ mood.label }}</span>
          </button>
          <button
            *ngIf="selectedMood()"
            (click)="selectMood(null)"
            class="px-3 py-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm"
          >
            Clear
          </button>
        </div>
      </div>

      <!-- Guided Journal (Collapsible) -->
      <div class="mb-6">
        <button
          (click)="toggleGuidedJournal()"
          class="flex items-center gap-2 text-sm font-medium text-zinc-300 hover:text-white transition-colors mb-3"
        >
          <svg
            class="h-4 w-4 transition-transform"
            [class.rotate-90]="showGuidedJournal()"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
          Guided journal (optional)
        </button>

        <div *ngIf="showGuidedJournal()" class="space-y-4 pl-6">
          <div>
            <label class="block text-sm font-medium text-zinc-400 mb-2">
              What went well?
            </label>
            <textarea
              [value]="wentWell()"
              (input)="wentWell.set($any($event.target).value); onJournalChange()"
              rows="3"
              placeholder="The positive things today..."
              class="w-full bg-background border border-zinc-700 rounded-lg px-4 py-2 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand resize-none text-sm"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-zinc-400 mb-2">
              Challenges and difficulties
            </label>
            <textarea
              [value]="challenges()"
              (input)="challenges.set($any($event.target).value); onJournalChange()"
              rows="3"
              placeholder="The difficulties encountered..."
              class="w-full bg-background border border-zinc-700 rounded-lg px-4 py-2 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand resize-none text-sm"
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-zinc-400 mb-2">
              What I learned
            </label>
            <textarea
              [value]="takeaway()"
              (input)="takeaway.set($any($event.target).value); onJournalChange()"
              rows="3"
              placeholder="Lessons and insights from today..."
              class="w-full bg-background border border-zinc-700 rounded-lg px-4 py-2 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand resize-none text-sm"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Tags -->
      <div>
        <label class="block text-sm font-medium text-zinc-300 mb-2">
          Tag
        </label>
        <div class="flex flex-wrap gap-2 mb-3">
          <span
            *ngFor="let tag of currentTags()"
            class="inline-flex items-center gap-1.5 px-3 py-1 rounded-md text-sm font-medium bg-brand/10 text-brand border border-brand/20"
          >
            {{ tag }}
            <button
              (click)="removeTag(tag)"
              class="hover:text-brand/70 transition-colors"
            >
              <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </span>
        </div>
        <div class="flex gap-2">
          <input
            type="text"
            [value]="tagInput()"
            (input)="tagInput.set($any($event.target).value)"
            (keydown)="onTagKeyDown($event)"
            placeholder="Add tag..."
            class="flex-1 bg-background border border-zinc-700 rounded-md px-4 py-2 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand text-sm"
          />
          <button
            (click)="addTag()"
            [disabled]="!tagInput().trim()"
            class="px-4 py-2 bg-zinc-800 text-zinc-300 rounded-md hover:bg-zinc-700 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Add
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
