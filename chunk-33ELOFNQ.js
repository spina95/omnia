import{a as S}from"./chunk-QPMMAPE7.js";import{L as w,P as v,m as f,rc as y,sc as T}from"./chunk-ELVZURTH.js";var A={NYSE:"USA",NASDAQ:"USA",NasdaqGS:"USA",NasdaqGM:"USA",NasdaqCM:"USA",NYQ:"USA",PCX:"USA",XETRA:"Germany",FRA:"Germany",LSE:"United Kingdom",LON:"United Kingdom",TSE:"Japan",JPX:"Japan","Euronext Paris":"France",PAR:"France",SIX:"Switzerland",VTX:"Switzerland",BME:"Spain",BIT:"Italy",MIL:"Italy",AMS:"Netherlands",TSX:"Canada",TOR:"Canada",ASX:"Australia",HKSE:"Hong Kong",HKG:"Hong Kong",SSE:"China",SHH:"China",SZSE:"China",SHZ:"China",BSE:"India",NSE:"India",BOM:"India"},_=class b{constructor(e,t){this.supabase=e;this.http=t}async getTransactions(e){let t=e?.page||1,r=e?.pageSize||100,o=(t-1)*r,c=o+r-1,{data:i}=await this.supabase.client.auth.getSession();console.log("\u{1F510} Current session:",i?.session?"Authenticated":"Not authenticated"),console.log("\u{1F464} User ID:",i?.session?.user?.id);let s=this.supabase.client.from("investment_transactions").select("*",{count:"exact"}).order("transaction_date",{ascending:!1});e?.ticker&&(s=s.ilike("ticker",e.ticker)),e?.transactionType&&(s=s.eq("transaction_type",e.transactionType)),e?.startDate&&(s=s.gte("transaction_date",e.startDate)),e?.endDate&&(s=s.lte("transaction_date",e.endDate)),s=s.range(o,c);let{data:g,error:l,count:u}=await s;if(console.log("\u{1F4CA} Investment transactions query result:",{dataCount:g?.length,totalCount:u,error:l}),l)throw console.error("\u274C Error fetching transactions:",l),new Error(l.message);return{data:g||[],count:u||0}}async getTransactionById(e){let{data:t,error:r}=await this.supabase.client.from("investment_transactions").select("*").eq("id",e).single();if(r)throw console.error("Error fetching transaction:",r),new Error(r.message);return t}async createTransaction(e){let{data:t,error:r}=await this.supabase.client.from("investment_transactions").insert(e).select().single();if(r)throw console.error("Error creating transaction:",r),new Error(r.message);return t}async updateTransaction(e,t){let{data:r,error:o}=await this.supabase.client.from("investment_transactions").update(t).eq("id",e).select().single();if(o)throw console.error("Error updating transaction:",o),new Error(o.message);return r}async deleteTransaction(e){let{error:t}=await this.supabase.client.from("investment_transactions").delete().eq("id",e);if(t)throw console.error("Error deleting transaction:",t),new Error(t.message)}async getCurrentPrice(e){let{data:t,error:r}=await this.supabase.client.from("investment_current_prices").select("*").eq("ticker",e).single();return r&&r.code!=="PGRST116"?(console.error("Error fetching current price:",r),null):t}async validateTicker(e){try{if(e.includes("."))return{valid:!0,exchangeName:e.split(".")[1],error:void 0};let r=`https://finnhub.io/api/v1/stock/profile2?symbol=${e}&token=${y.finnhub.apiKey}`,o=await f(this.http.get(r));return!o||!o.ticker?{valid:!1,error:"Ticker not found. For non-US stocks, use format: TICKER.EXCHANGE (e.g., BMW.DE, AIR.PA)"}:{valid:!0,exchangeName:o.exchange}}catch(t){return console.error("Error validating ticker:",t),t.status===429?{valid:!1,error:"Rate limit reached. Please try again later."}:t.status===403||t.error?.message?.includes("access")?{valid:!1,error:"API access denied. Please verify your Finnhub API key in environment.development.ts"}:{valid:!1,error:`Failed to validate ticker: ${t.error?.message||t.message||"Unknown error"}. Try format: TICKER or TICKER.EXCHANGE`}}}async refreshPrice(e){try{if(e.includes(".")){let u=await this.getCurrentPrice(e);if(u)return console.info(`Using cached price for ${e} (Finnhub free tier doesn't support this exchange)`),u;throw new Error(`${e} requires manual price entry. Finnhub free tier doesn't support this exchange.`)}let r=`https://finnhub.io/api/v1/quote?symbol=${e}&token=${y.finnhub.apiKey}`,o=await f(this.http.get(r));if(!o||o.c===0)throw new Error(`No data available for ${e}. Try format: TICKER or TICKER.EXCHANGE`);let c=`https://finnhub.io/api/v1/stock/profile2?symbol=${e}&token=${y.finnhub.apiKey}`,i=await f(this.http.get(c)),s={ticker:e.toUpperCase(),price:o.c,currency:i?.currency||"USD",exchange_name:i?.exchange||void 0},{data:g,error:l}=await this.supabase.client.from("investment_current_prices").upsert(s,{onConflict:"ticker"}).select();if(l)throw console.error("Error saving price:",l),new Error(l.message);return g&&g.length>0?g[0]:s}catch(t){if(console.error("Error refreshing price:",t),t.status===429)throw new Error(`Rate limit reached for ${e}. Please try again later.`);if(t.status===403||t.error?.message?.includes("access"))throw new Error(`API access denied for ${e}. Please verify your Finnhub API key.`);let r=t.error?.message||t.message||"Unknown error";throw new Error(`Failed to fetch price for ${e}: ${r}`)}}async getPortfolioSummary(e=!1){try{let{data:t}=await this.getTransactions({pageSize:1e4});if(console.log("\u{1F4BC} Getting portfolio summary, transactions:",t?.length),!t||t.length===0)return console.log("\u26A0\uFE0F No transactions found"),{holdings:[],totalValue:0,totalCost:0,totalGainLoss:0,totalGainLossPercent:0};let r=new Map;for(let a of t){let n=r.get(a.ticker)||{totalQuantity:0,totalCost:0,transactions:[]};if(a.transaction_type==="BUY")n.totalQuantity+=a.quantity,n.totalCost+=a.quantity*a.purchase_price;else if(a.transaction_type==="SELL"){n.totalQuantity-=a.quantity;let p=n.totalCost/(n.totalQuantity+a.quantity);n.totalCost-=a.quantity*p}n.transactions.push(a),r.set(a.ticker,n)}let c=Array.from(r.keys()).map(async a=>{let n=await this.getCurrentPrice(a);if(e||!n||this.isPriceStale(n.last_updated))try{n=await this.refreshPrice(a)}catch(p){let P=p?.message||String(p);if(console.info(`Could not refresh price for ${a}: ${P}`),!n){let m=r.get(a)?.transactions[0];m&&(console.info(`Using last transaction price for ${a}: \u20AC${m.purchase_price}`),n={ticker:a,price:m.purchase_price,currency:"EUR",exchange_name:void 0,last_updated:m.transaction_date})}}return{ticker:a,price:n?.price||0}}),i=await Promise.all(c),s=new Map(i.map(a=>[a.ticker,a.price])),g=[],l=0,u=0;for(let[a,n]of r.entries()){if(n.totalQuantity<=0)continue;let p=s.get(a)||0,P=n.totalCost/n.totalQuantity,h=n.totalQuantity*p,m=h-n.totalCost,x=n.totalCost>0?m/n.totalCost*100:0,C=n.transactions[0]?.ticker?await this.getExchangeForTicker(a):void 0;g.push({ticker:a,totalQuantity:n.totalQuantity,averageCost:P,currentPrice:p,totalCost:n.totalCost,currentValue:h,gainLoss:m,gainLossPercent:x,exchange:C,country:C?this.mapExchangeToCountry(C):void 0}),l+=h,u+=n.totalCost}let E=l-u,I=u>0?E/u*100:0,d={holdings:g.sort((a,n)=>n.currentValue-a.currentValue),totalValue:l,totalCost:u,totalGainLoss:E,totalGainLossPercent:I};return console.log("\u{1F4C8} Portfolio summary calculated:",{holdingsCount:d.holdings.length,totalValue:d.totalValue,totalCost:d.totalCost}),d}catch(t){throw console.error("\u274C Error calculating portfolio summary:",t),t}}async getGeographicalAllocation(e=!1){try{let t=await this.getPortfolioSummary(e);if(!t.holdings||t.holdings.length===0)return[];let r=new Map;for(let c of t.holdings){let i=c.country||"Unknown",s=r.get(i)||0;r.set(i,s+c.currentValue)}let o=[];for(let[c,i]of r.entries())o.push({country:c,value:i,percentage:t.totalValue>0?i/t.totalValue*100:0});return o.sort((c,i)=>i.value-c.value)}catch(t){throw console.error("Error calculating geographical allocation:",t),t}}async getUniqueTickers(){let{data:e,error:t}=await this.supabase.client.from("investment_transactions").select("ticker").order("ticker");return t?(console.error("Error fetching unique tickers:",t),[]):[...new Set(e.map(o=>o.ticker))]}isPriceStale(e){let t=new Date,r=new Date(e);return(t.getTime()-r.getTime())/(1e3*60)>15}async getExchangeForTicker(e){return(await this.getCurrentPrice(e))?.exchange_name}mapExchangeToCountry(e){return A[e]||"Other"}static \u0275fac=function(t){return new(t||b)(v(T),v(S))};static \u0275prov=w({token:b,factory:b.\u0275fac,providedIn:"root"})};export{_ as a};
