# Budgets Feature Implementation

This document summarizes the implementation of the budgets feature for the Omnia finance application.

## What Was Implemented

### 1. Database Schema

#### Budgets Table
- **Location**: `src/migrations/001_create_budgets_table.sql`
- **Schema**:
  ```sql
  CREATE TABLE budgets (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    max_amount NUMERIC NOT NULL,
    payment_type_id BIGINT NOT NULL REFERENCES payment_types(id),
    category_id BIGINT REFERENCES expense_categories(id),
    period VARCHAR(10) NOT NULL CHECK (period IN ('weekly', 'monthly', 'yearly')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(payment_type_id, category_id, period)
  );
  ```

#### Budget Spending Function
- **Location**: `src/migrations/002_create_budget_spending_function.sql`
- **Purpose**: Calculates current spending vs budget limit based on period (weekly/monthly/yearly)
- **Features**:
  - NULL category_id = track all categories for that payment type
  - Specific category_id = track only that category for the payment type
  - Returns spending amount and percentage used

### 2. Frontend Components

#### Budgets List Component
- **Location**: `src/app/features/finance/budgets/budgets.ts`
- **Features**:
  - Display all budgets with progress bars
  - Show spending vs limit with percentage
  - Edit and delete budget functionality
  - Empty state with create budget CTA

#### Budget Dialog Component
- **Location**: `src/app/features/finance/budget-dialog/budget-dialog.ts`
- **Features**:
  - Create and edit budgets
  - Select payment type and optional category
  - Choose period (weekly/monthly/yearly)
  - Form validation

#### Budget Interface
- **Location**: `src/app/features/finance/budgets/budget.interface.ts`
- **Types**: Budget, BudgetSpending

### 3. Backend Integration

#### Finance Service Updates
- **Location**: `src/app/core/services/finance.ts`
- **New Methods**:
  - `getBudgets()`: Fetch all budgets with related data
  - `createBudget()`: Create new budget
  - `updateBudget()`: Update existing budget
  - `deleteBudget()`: Delete budget
  - `getBudgetSpending()`: Calculate spending vs budget

### 4. Navigation & Routing

#### Sidebar Menu
- **Location**: `src/app/features/layout/sidebar/sidebar.component.ts`
- **Added**: Budgets menu item with icon

#### Routes
- **Location**: `src/app/app.routes.ts`
- **Added**: `/budgets` route

## How to Use

### 1. Database Setup

**Important**: You need to run the database migrations to create the budgets table and function.

**Option A: Using Supabase CLI**
```bash
# Navigate to your project directory
cd /path/to/omnia

# Run the migrations
supabase migration new create_budgets_table
# Copy the SQL from src/migrations/001_create_budgets_table.sql

supabase migration new create_budget_spending_function
# Copy the SQL from src/migrations/002_create_budget_spending_function.sql

supabase migration up
```

**Option B: Manual SQL Execution**
```bash
# Connect to your Supabase database and run:
psql -h db.xxxx.supabase.co -U postgres -d postgres

# Then execute the SQL from:
# src/migrations/001_create_budgets_table.sql
# src/migrations/002_create_budget_spending_function.sql
```

### 2. Creating a Budget

1. Navigate to **Budgets** in the sidebar
2. Click **Add Budget**
3. Select a **Payment Type** (required)
4. Select a **Category** (optional - leave as "All Categories" to track all categories)
5. Choose a **Period** (weekly, monthly, or yearly)
6. Set the **Max Amount**
7. Click **Create Budget**

### 3. Budget Tracking

The budgets page shows:
- **Progress bars** with spending percentage
- **Current spending** vs **budget limit**
- **Payment type** and **category** (if specified)
- **Period** indicator

### 4. Budget Management

- **Edit**: Click the edit icon to modify budget details
- **Delete**: Click the delete icon to remove a budget
- **Progress**: Visual indication of budget usage with color-coded progress bars

## Technical Details

### Budget Logic

1. **NULL Category**: When category_id is NULL, the budget tracks spending across ALL expense categories for the selected payment type.

2. **Specific Category**: When category_id has a value, the budget tracks spending only for that specific category and payment type combination.

3. **Period Calculation**:
   - **Weekly**: Last 7 days (including today)
   - **Monthly**: Current month only
   - **Yearly**: Current year only

### Progress Bar Colors

The progress bars use the payment type's color for visual consistency:
- Each payment type has a defined color (e.g., Cash = green, Bank = blue)
- Progress bars match the payment type color
- Visual feedback on budget usage (0-100%)

### Responsive Design

- Grid layout adapts to screen size (1 column on mobile, 3 columns on desktop)
- Consistent with existing application design patterns
- Dark mode support

## Next Steps

1. **Run the database migrations** to create the necessary tables and functions
2. **Test the budget creation and tracking** functionality
3. **Consider adding budget alerts** when approaching limits
4. **Add budget history** to track changes over time
5. **Implement budget reports** for detailed spending analysis

## Files Created/Modified

### New Files
- `src/migrations/001_create_budgets_table.sql`
- `src/migrations/002_create_budget_spending_function.sql`
- `src/app/features/finance/budgets/budgets.ts`
- `src/app/features/finance/budgets/budgets.html`
- `src/app/features/finance/budgets/budgets.css`
- `src/app/features/finance/budgets/budget.interface.ts`
- `src/app/features/finance/budget-dialog/budget-dialog.ts`
- `src/app/features/finance/budget-dialog/budget-dialog.html`
- `src/app/features/finance/budget-dialog/budget-dialog.css`
- `BUDGETS_IMPLEMENTATION.md`

### Modified Files
- `src/app/core/services/finance.ts` - Added budget CRUD operations
- `src/app/features/layout/sidebar/sidebar.component.ts` - Added Budgets menu item
- `src/app/app.routes.ts` - Added budgets route

The budgets feature is now fully implemented and ready for use once the database migrations are applied!
