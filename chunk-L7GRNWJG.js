import{L as b,P as E,qc as x}from"./chunk-TKY7A7V6.js";import{a as p,b as S}from"./chunk-VOSPIT4N.js";var d=class{static normalizeTag(e){return e.toLowerCase().trim().replace(/\s+/g," ")}static normalizeTags(e){let r=e.map(t=>this.normalizeTag(t)).filter(t=>t.length>0);return Array.from(new Set(r))}static createExcerpt(e,r=150){if(!e)return"";let t=e.trim();return t.length<=r?t:t.substring(0,r).trim()+"..."}static formatDate(e){return e.toISOString().split("T")[0]}static parseDate(e){return new Date(e+"T00:00:00")}static getToday(){return this.formatDate(new Date)}static isValidDateString(e){if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;let t=this.parseDate(e);return!isNaN(t.getTime())}};var I=class _{constructor(e){this.supabaseService=e}async getCurrentUserId(){let{data:e}=await this.supabaseService.client.auth.getUser();return e?.user?.id??null}async getDayEntry(e){let r=await this.getCurrentUserId();if(!r)return null;let{data:t,error:a}=await this.supabaseService.client.from("day_entries").select(`
        *,
        tasks:day_tasks(*),
        journal:journal_entries(*)
      `).eq("user_id",r).eq("entry_date",e).single();if(!a&&t)return this.transformDayEntry(t);let{data:s,error:n}=await this.supabaseService.client.from("day_entries").insert({user_id:r,entry_date:e}).select().single();return n?(console.error("Error creating day entry:",n),null):S(p({},s),{tasks:[],journal:void 0})}async updateDayEntry(e,r){let t=await this.getCurrentUserId();if(!t)return!1;let{error:a}=await this.supabaseService.client.from("day_entries").update(r).eq("id",e).eq("user_id",t);return a?(console.error("Error updating day entry:",a),!1):!0}async getRecentDays(e=30){let r=await this.getCurrentUserId();if(!r)return[];let{data:t,error:a}=await this.supabaseService.client.from("day_entries").select(`
        *,
        tasks:day_tasks(id),
        journal:journal_entries(id, tags)
      `).eq("user_id",r).order("entry_date",{ascending:!1}).limit(e);return a?(console.error("Error fetching recent days:",a),[]):(t||[]).map(s=>this.transformDayEntry(s))}async createTask(e,r){let t=await this.getCurrentUserId();if(!t)return null;let{data:a}=await this.supabaseService.client.from("day_entries").select("id").eq("id",e).eq("user_id",t).single();if(!a)return console.error("Day entry not found or unauthorized"),null;let{data:s,error:n}=await this.supabaseService.client.from("day_tasks").insert({day_entry_id:e,text:r.text,status:r.status||"todo",task_order:r.task_order||0}).select().single();return n?(console.error("Error creating task:",n),null):s}async updateTask(e,r){if(!await this.getCurrentUserId())return!1;let{error:a}=await this.supabaseService.client.from("day_tasks").update(r).eq("id",e);return a?(console.error("Error updating task:",a),!1):!0}async deleteTask(e){if(!await this.getCurrentUserId())return!1;let{error:t}=await this.supabaseService.client.from("day_tasks").delete().eq("id",e);return t?(console.error("Error deleting task:",t),!1):!0}async updateTaskOrders(e){if(!await this.getCurrentUserId())return!1;try{let t=e.map(a=>this.supabaseService.client.from("day_tasks").update({task_order:a.task_order}).eq("id",a.id));return await Promise.all(t),!0}catch(t){return console.error("Error updating task orders:",t),!1}}async updateJournal(e,r){let t=await this.getCurrentUserId();if(!t)return!1;let{data:a}=await this.supabaseService.client.from("day_entries").select("id").eq("id",e).eq("user_id",t).single();if(!a)return console.error("Day entry not found or unauthorized"),!1;let s=p({},r);r.tags&&(s.tags=d.normalizeTags(r.tags));let{data:n}=await this.supabaseService.client.from("journal_entries").select("id").eq("day_entry_id",e).single();if(n){let{error:o}=await this.supabaseService.client.from("journal_entries").update(s).eq("day_entry_id",e);if(o)return console.error("Error updating journal:",o),!1}else{let{error:o}=await this.supabaseService.client.from("journal_entries").insert(p({day_entry_id:e},s));if(o)return console.error("Error creating journal:",o),!1}return!0}async searchByTags(e){let r=await this.getCurrentUserId();if(!r)return{results:[],total:0};let{tags:t,mode:a,page:s=1,pageSize:n=12}=e,o=(s-1)*n,f=o+n-1,l=d.normalizeTags(t),c=this.supabaseService.client.from("day_entries").select(`
        *,
        journal:journal_entries(*)
      `,{count:"exact"}).eq("user_id",r).order("entry_date",{ascending:!1});l.length>0&&(a==="AND"?c=c.contains("journal.tags",l):c=c.overlaps("journal.tags",l));let{data:g,error:y,count:m}=await c.range(o,f);return y?(console.error("Error searching by tags:",y),{results:[],total:0}):{results:(g||[]).filter(i=>i.journal).map(i=>({dayEntry:this.transformDayEntry(i),excerpt:d.createExcerpt(i.journal.free_text),matchedTags:this.getMatchedTags(i.journal.tags,l)})),total:m||0}}async getAllTags(){if(!await this.getCurrentUserId())return[];let{data:r,error:t}=await this.supabaseService.client.from("journal_entries").select("tags, day_entry_id").order("created_at",{ascending:!1});if(t)return console.error("Error fetching tags:",t),[];let a=new Map;return(r||[]).forEach(s=>{s.tags&&Array.isArray(s.tags)&&s.tags.forEach(n=>{let o=d.normalizeTag(n);a.set(o,(a.get(o)||0)+1)})}),Array.from(a.entries()).map(([s,n])=>({tag:s,count:n})).sort((s,n)=>n.count-s.count)}async getEntriesForMonth(e,r){let t=await this.getCurrentUserId();if(!t)return[];let a=`${e}-${String(r).padStart(2,"0")}-01`,s=new Date(e,r,0).toISOString().split("T")[0],{data:n,error:o}=await this.supabaseService.client.from("day_entries").select(`
        *,
        tasks:day_tasks(id, status),
        journal:journal_entries(id)
      `).eq("user_id",t).gte("entry_date",a).lte("entry_date",s).order("entry_date",{ascending:!0});return o?(console.error("Error fetching entries for month:",o),[]):(n||[]).map(f=>this.transformDayEntry(f))}async getDaysWithEntries(e,r){let t=await this.getCurrentUserId();if(!t)return[];let a=`${e}-${String(r).padStart(2,"0")}-01`,s=new Date(e,r,0).toISOString().split("T")[0],{data:n,error:o}=await this.supabaseService.client.from("day_entries").select(`
        entry_date,
        mood,
        tasks:day_tasks(id),
        journal:journal_entries(id, free_text, went_well, challenges, takeaway, tags)
      `).eq("user_id",t).gte("entry_date",a).lte("entry_date",s);return o?(console.error("Error fetching days with entries:",o),[]):(console.log("[getDaysWithEntries] Raw data:",JSON.stringify(n,null,2)),(n||[]).filter(l=>{let c=l.tasks&&l.tasks.length>0,g=l.mood&&l.mood.trim()!=="",y=l.journal,m=!1;return y&&(m=(Array.isArray(y)?y:[y]).some(i=>{if(!i)return!1;let h=i.free_text&&i.free_text.trim()!=="",w=i.went_well&&i.went_well.trim()!=="",u=i.challenges&&i.challenges.trim()!=="",T=i.takeaway&&i.takeaway.trim()!=="",k=i.tags&&Array.isArray(i.tags)&&i.tags.length>0;return h||w||u||T||k})),c||g||m}).map(l=>l.entry_date))}async getNearestDayWithEntries(e,r,t=365){let a=await this.getCurrentUserId();if(!a)return null;let s=d.parseDate(e),n=d.getToday(),o=r==="next"?1:-1;for(let f=1;f<=t;f++){let l=new Date(s.getTime());l.setUTCDate(l.getUTCDate()+f*o);let c=d.formatDate(l);if(r==="next"&&c>n)break;let{data:g,error:y}=await this.supabaseService.client.from("day_entries").select(`
          entry_date,
          mood,
          tasks:day_tasks(id),
          journal:journal_entries(id, free_text, went_well, challenges, takeaway, tags)
        `).eq("user_id",a).eq("entry_date",c).maybeSingle();if(y){console.error("Error checking day entry:",y);continue}if(!g)continue;let m=g.tasks&&g.tasks.length>0,D=g.mood&&g.mood.trim()!=="",i=g.journal,h=!1;if(i&&(h=(Array.isArray(i)?i:[i]).some(u=>{if(!u)return!1;let T=u.free_text&&u.free_text.trim()!=="",k=u.went_well&&u.went_well.trim()!=="",v=u.challenges&&u.challenges.trim()!=="",C=u.takeaway&&u.takeaway.trim()!=="",U=u.tags&&Array.isArray(u.tags)&&u.tags.length>0;return T||k||v||C||U})),m||D||h)return c}return null}transformDayEntry(e){return{id:e.id,user_id:e.user_id,entry_date:e.entry_date,mood:e.mood,created_at:e.created_at,updated_at:e.updated_at,tasks:Array.isArray(e.tasks)?e.tasks:[],journal:e.journal||void 0}}getMatchedTags(e,r){return!e||!Array.isArray(e)?[]:e.filter(t=>r.includes(d.normalizeTag(t)))}static \u0275fac=function(r){return new(r||_)(E(x))};static \u0275prov=b({token:_,factory:_.\u0275fac,providedIn:"root"})};export{d as a,I as b};
